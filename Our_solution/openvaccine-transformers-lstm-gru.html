
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Meet‚Äôs code &#8212; üçÄ Co-weed&#39;19</title>
    
  <link rel="stylesheet" href="../_static/css/index.73d71520a4ca3b99cfee5594769eaaae.css">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="../_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="../_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="../_static/sphinx-book-theme.2d2078699c18a0efb88233928e1cf6ed.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.3da636dd464baa7582d2.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.be0a4a0c39cd630af62a2fcf693f3f06.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Meet‚Äôs Single Models Details" href="single-model-results.html" />
    <link rel="prev" title="Vatsal‚Äôs Single Model Details" href="Single_model_Perfomance.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../index.html">
  
  <img src="../_static/logo_1.png" class="logo" alt="logo">
  
  
  <h1 class="site-logo" id="site-title">üçÄ Co-weed'19</h1>
  
</a>
</div>

<form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form>

<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../Introduction/Introduction.html">
   üôãüèª‚Äç‚ôÇÔ∏è Introduction
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  ü§î Project Overview
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../Project_Overview/description.html">
   Description
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Project_Overview/evaluation.html">
   Evaluation
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  üîç Exploratory Data Analysis
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../EDA/openvaccine-eda.html">
   EDA by Vatsal
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../EDA/openvaccine-interesting-visualizations.html">
   EDA by Meet
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  üß™ Things we tried
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../Things_we_tried/CV_strategy.html">
   Stratification by the signal_to_noise
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Things_we_tried/openvaccine-feature-extraction.html">
   Feature extraction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Things_we_tried/augmentation.html">
   structure augmentation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Things_we_tried/openvaccine-t-sne-rapids.html">
   T-SNE - Rapids
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  üí° Our Solution
 </span>
</p>
<ul class="current nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="openvaccine-model-training-augmentation.html">
   Vatsal‚Äôs Code
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Single_model_Perfomance.html">
   Vatsal‚Äôs Single Model Details
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Meet‚Äôs code
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="single-model-results.html">
   Meet‚Äôs Single Models Details
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="ensemblingResults.html">
   Ensemble Results
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  üìù Reference Material
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../Reference_material/index.html">
   Material
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  üó£ Discussion Forum Material
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../Discussion_material/tsne_visualization.html">
   TSNE visualization
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Discussion_material/Graph_representation_of_RNA.html">
   Graph representation of RNA
  </a>
 </li>
</ul>

</nav>

 <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="row topbar fixed-top container-xl">
    <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show">
    </div>
    <div class="col pl-2 topbar-main">
        
        <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
            data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
            aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
            title="Toggle navigation" data-toggle="tooltip" data-placement="left">
            <i class="fas fa-bars"></i>
            <i class="fas fa-arrow-left"></i>
            <i class="fas fa-arrow-up"></i>
        </button>
        
        <div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    
    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/Our_solution/openvaccine-transformers-lstm-gru.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
    
</div>
        <!-- Source interaction buttons -->


        <!-- Full screen (wrap in <a> to have style consistency -->
        <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
                title="Fullscreen mode"><i
                    class="fas fa-expand"></i></button></a>

        <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/executablebooks/jupyter-book/master?urlpath=tree/Our_solution/openvaccine-transformers-lstm-gru.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        <a class="colab-button" href="https://colab.research.google.com/github/executablebooks/jupyter-book/blob/master/Our_solution/openvaccine-transformers-lstm-gru.ipynb"><button type="button" class="btn btn-secondary topbarbtn"
                title="Launch Colab" data-toggle="tooltip" data-placement="left"><img class="colab-button-logo"
                    src="../_static/images/logo_colab.png"
                    alt="Interact on Colab">Colab</button></a>
        
        
    </div>
</div>

    </div>

    <!-- Table of contents -->
    <div class="d-none d-md-block col-md-2 bd-toc show">
        
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i> Contents
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#import-necessary-libraries">
   1. Import Necessary Libraries
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#load-data">
   2. Load Data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#preprocessing">
   3. Preprocessing
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#model">
   4. Model
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#positional-encoding">
     Positional Encoding
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#multiheaded-attention">
     Multiheaded Attention
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#encoder-layer">
     Encoder-Layer
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#gru-lstms">
     GRU-LSTMs
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#transformers">
     Transformers
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#lr-schedulers">
   5. LR Schedulers
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#training">
   6. Training
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#validation-scheme">
     Validation Scheme
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#inference">
   7. Inference
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#test-set-predictions">
     8. Test set Predictions
    </a>
   </li>
  </ul>
 </li>
</ul>

        </nav>
        
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="meet-s-code">
<h1>Meet‚Äôs code<a class="headerlink" href="#meet-s-code" title="Permalink to this headline">¬∂</a></h1>
<div class="section" id="import-necessary-libraries">
<h2>1. Import Necessary Libraries<a class="headerlink" href="#import-necessary-libraries" title="Permalink to this headline">¬∂</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">defaultdict</span><span class="p">,</span><span class="n">Counter</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;fivethirtyeight&#39;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">tensorflow_addons</span> <span class="k">as</span> <span class="nn">tfa</span>
<span class="kn">import</span> <span class="nn">keras.backend</span> <span class="k">as</span> <span class="nn">K</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tensorflow version: &quot;</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>

<span class="c1"># from transformers import *</span>

<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="k">import</span> <span class="n">StratifiedKFold</span><span class="p">,</span> <span class="n">KFold</span><span class="p">,</span> <span class="n">GroupKFold</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="k">import</span> <span class="n">mean_squared_error</span>

<span class="kn">from</span> <span class="nn">tqdm</span> <span class="k">import</span> <span class="n">tqdm</span> 
<span class="kn">import</span> <span class="nn">itertools</span>

<span class="n">SEED</span> <span class="o">=</span> <span class="mi">2020</span>

<span class="k">def</span> <span class="nf">seed_everything</span><span class="p">(</span><span class="n">SEED</span><span class="p">):</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">SEED</span><span class="p">)</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="n">SEED</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PYTHONHASHSEED&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">SEED</span><span class="p">)</span>

<span class="n">seed_everything</span><span class="p">(</span><span class="n">SEED</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ModuleNotFoundError</span><span class="g g-Whitespace">                       </span>Traceback (most recent call last)
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">2737</span><span class="n">a4e9de27</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">     </span><span class="mi">14</span> 
<span class="g g-Whitespace">     </span><span class="mi">15</span> <span class="kn">import</span> <span class="nn">tensorflow</span> <span class="kn">as</span> <span class="nn">tf</span>
<span class="ne">---&gt; </span><span class="mi">16</span> <span class="kn">import</span> <span class="nn">tensorflow_addons</span> <span class="kn">as</span> <span class="nn">tfa</span>
<span class="g g-Whitespace">     </span><span class="mi">17</span> <span class="kn">import</span> <span class="nn">keras.backend</span> <span class="kn">as</span> <span class="nn">K</span>
<span class="g g-Whitespace">     </span><span class="mi">18</span> <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Tensorflow version: &quot;</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>

<span class="ne">ModuleNotFoundError</span>: No module named &#39;tensorflow_addons&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">AUGMENTED</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">OHE</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="load-data">
<h2>2. Load Data<a class="headerlink" href="#load-data" title="Permalink to this headline">¬∂</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">PATH</span> <span class="o">=</span> <span class="s1">&#39;/kaggle/input/stanford-covid-vaccine&#39;</span>
<span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">PATH</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;test.json&#39;, &#39;train.json&#39;, &#39;sample_submission.csv&#39;, &#39;bpps&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH</span><span class="p">,</span><span class="s1">&#39;train.json&#39;</span><span class="p">),</span><span class="n">lines</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH</span><span class="p">,</span><span class="s1">&#39;test.json&#39;</span><span class="p">),</span><span class="n">lines</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">sub</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH</span><span class="p">,</span><span class="s1">&#39;sample_submission.csv&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">AUGMENTED</span><span class="p">:</span>
    <span class="n">train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="s1">&#39;../input/openvaccine/train.json&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="s1">&#39;../input/openvaccine/test.json&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">test</span> <span class="o">=</span> <span class="n">test</span><span class="p">[</span><span class="n">test</span><span class="o">.</span><span class="n">cnt</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_bppm</span><span class="p">(</span><span class="n">id_</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH</span><span class="p">,</span><span class="n">f</span><span class="s2">&quot;bpps/</span><span class="si">{id_}</span><span class="s2">.npy&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>level_0</th>
      <td>0</td>
      <td>1</td>
      <td>2</td>
      <td>3</td>
      <td>4</td>
    </tr>
    <tr>
      <th>id</th>
      <td>id_001f94081</td>
      <td>id_0049f53ba</td>
      <td>id_006f36f57</td>
      <td>id_0082d463b</td>
      <td>id_0087940f4</td>
    </tr>
    <tr>
      <th>sequence</th>
      <td>GGAAAAGCUCUAAUAACAGGAGACUAGGACUACGUAUUUCUAGGUA...</td>
      <td>GGAAAAAGCGCGCGCGGUUAGCGCGCGCUUUUGCGCGCGCUGUACC...</td>
      <td>GGAAAGUGCUCAGAUAAGCUAAGCUCGAAUAGCAAUCGAAUAGAAU...</td>
      <td>GGAAAAGCGCGCGCGCGCGCGCGAAAAAGCGCGCGCGCGCGCGCGC...</td>
      <td>GGAAAAUAUAUAAUAUAUUAUAUAAAUAUAUUAUAGAAGUAUAAUA...</td>
    </tr>
    <tr>
      <th>structure</th>
      <td>.....((((((.......)))).)).((.....((..((((((......</td>
      <td>.....(((((((((((((((((((((((....)))))))))).)))...</td>
      <td>.....((((.((.....((((.(((.....)))..((((......)...</td>
      <td>......((((((((((((((((......))))))))))))))))((...</td>
      <td>.....(((((((.((((((((((((.(((((((((....)))))))...</td>
    </tr>
    <tr>
      <th>signal_to_noise</th>
      <td>6.894</td>
      <td>0.193</td>
      <td>8.8</td>
      <td>0.104</td>
      <td>0.423</td>
    </tr>
    <tr>
      <th>SN_filter</th>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>seq_length</th>
      <td>107</td>
      <td>107</td>
      <td>107</td>
      <td>107</td>
      <td>107</td>
    </tr>
    <tr>
      <th>seq_scored</th>
      <td>68</td>
      <td>68</td>
      <td>68</td>
      <td>68</td>
      <td>68</td>
    </tr>
    <tr>
      <th>reactivity_error</th>
      <td>[0.1359, 0.20700000000000002, 0.1633, 0.1452, ...</td>
      <td>[2.8272, 2.8272, 2.8272, 4.7343, 2.5676, 2.567...</td>
      <td>[0.0931, 0.13290000000000002, 0.11280000000000...</td>
      <td>[3.5229, 6.0748, 3.0374, 3.0374, 3.0374, 3.037...</td>
      <td>[1.665, 2.1728, 2.0041, 1.2405, 0.620200000000...</td>
    </tr>
    <tr>
      <th>deg_error_Mg_pH10</th>
      <td>[0.26130000000000003, 0.38420000000000004, 0.1...</td>
      <td>[73705.3985, 73705.3985, 73705.3985, 73705.398...</td>
      <td>[0.1365, 0.2237, 0.1812, 0.1333, 0.1148, 0.160...</td>
      <td>[73705.3985, 73705.3985, 73705.3985, 73705.398...</td>
      <td>[4.2139, 3.9637000000000002, 3.2467, 2.4716, 1...</td>
    </tr>
    <tr>
      <th>deg_error_pH10</th>
      <td>[0.2631, 0.28600000000000003, 0.0964, 0.1574, ...</td>
      <td>[10.1986, 9.2418, 5.0933, 5.0933, 5.0933, 5.09...</td>
      <td>[0.17020000000000002, 0.178, 0.111, 0.091, 0.0...</td>
      <td>[11.8007, 12.7566, 5.7733, 5.7733, 5.7733, 5.7...</td>
      <td>[3.0942, 3.015, 2.1212, 2.0552, 0.881500000000...</td>
    </tr>
    <tr>
      <th>deg_error_Mg_50C</th>
      <td>[0.1501, 0.275, 0.0947, 0.18660000000000002, 0...</td>
      <td>[16.6174, 13.868, 8.1968, 8.1968, 8.1968, 8.19...</td>
      <td>[0.1033, 0.1464, 0.1126, 0.09620000000000001, ...</td>
      <td>[121286.7181, 121286.7182, 121286.7181, 121286...</td>
      <td>[2.6717, 2.4818, 1.9919, 2.5484999999999998, 1...</td>
    </tr>
    <tr>
      <th>deg_error_50C</th>
      <td>[0.2167, 0.34750000000000003, 0.188, 0.2124, 0...</td>
      <td>[15.4857, 7.9596, 13.3957, 5.8777, 5.8777, 5.8...</td>
      <td>[0.14980000000000002, 0.1761, 0.1517, 0.116700...</td>
      <td>[15.3995, 8.1124, 7.7824, 7.7824, 7.7824, 7.78...</td>
      <td>[1.3285, 3.6173, 1.3057, 1.3021, 1.1507, 1.150...</td>
    </tr>
    <tr>
      <th>reactivity</th>
      <td>[0.3297, 1.5693000000000001, 1.1227, 0.8686, 0...</td>
      <td>[0.0, 0.0, 0.0, 2.2965, 0.0, 0.0, 0.0, 0.0, 0....</td>
      <td>[0.44820000000000004, 1.4822, 1.1819, 0.743400...</td>
      <td>[0.0, 2.2399, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0....</td>
      <td>[0.8267, 2.6577, 2.8481, 0.40090000000000003, ...</td>
    </tr>
    <tr>
      <th>deg_Mg_pH10</th>
      <td>[0.7556, 2.983, 0.2526, 1.3789, 0.637600000000...</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>[0.2504, 1.4021, 0.9804, 0.49670000000000003, ...</td>
      <td>[0.0, -0.5083, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0...</td>
      <td>[2.1058, 3.138, 2.5437000000000003, 1.0932, 0....</td>
    </tr>
    <tr>
      <th>deg_pH10</th>
      <td>[2.3375, 3.5060000000000002, 0.3008, 1.0108, 0...</td>
      <td>[4.947, 4.4523, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>[2.243, 2.9361, 1.0553, 0.721, 0.6396000000000...</td>
      <td>[3.4248, 6.8128, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,...</td>
      <td>[4.7366, 4.6243, 1.2068, 1.1538, 0.0, 0.0, 0.7...</td>
    </tr>
    <tr>
      <th>deg_Mg_50C</th>
      <td>[0.35810000000000003, 2.9683, 0.2589, 1.4552, ...</td>
      <td>[4.8511, 4.0426, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,...</td>
      <td>[0.5163, 1.6823000000000001, 1.0426, 0.7902, 0...</td>
      <td>[0.0, -0.8365, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0...</td>
      <td>[2.2052, 1.7947000000000002, 0.7457, 3.1233, 0...</td>
    </tr>
    <tr>
      <th>deg_50C</th>
      <td>[0.6382, 3.4773, 0.9988, 1.3228, 0.78770000000...</td>
      <td>[7.6692, 0.0, 10.9561, 0.0, 0.0, 0.0, 0.0, 0.0...</td>
      <td>[0.9501000000000001, 1.7974999999999999, 1.499...</td>
      <td>[7.6692, -1.3223, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0...</td>
      <td>[0.0, 5.1198, -0.3551, -0.3518, 0.0, 0.0, 0.0,...</td>
    </tr>
    <tr>
      <th>cnt</th>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>predicted_loop_type</th>
      <td>EEEEESSSSSSHHHHHHHSSSSBSSXSSIIIIISSIISSSSSSHHH...</td>
      <td>EEEEESSSSSSSSSSSSSSSSSSSSSSSHHHHSSSSSSSSSSBSSS...</td>
      <td>EEEEESSSSISSIIIIISSSSMSSSHHHHHSSSMMSSSSHHHHHHS...</td>
      <td>EEEEEESSSSSSSSSSSSSSSSHHHHHHSSSSSSSSSSSSSSSSSS...</td>
      <td>EEEEESSSSSSSBSSSSSSSSSSSSBSSSSSSSSSHHHHSSSSSSS...</td>
    </tr>
    <tr>
      <th>positional_entropy</th>
      <td>[1.7836361789000001, 1.3220812925, 0.437422162...</td>
      <td>[0.9360315124, 0.642767634, 0.3679182692000000...</td>
      <td>[0.5490099148, 0.4246442945, 0.1903313657, 0.0...</td>
      <td>[0.7474489873, 0.5149715144, 0.001054595, 0.00...</td>
      <td>[0.3282294382, 0.5151187306, 0.479566674700000...</td>
    </tr>
    <tr>
      <th>stems</th>
      <td>[0.0560747664, 0.0560747664, 0.0560747664, 0.0...</td>
      <td>[0.037383177600000005, 0.037383177600000005, 0...</td>
      <td>[0.0560747664, 0.0560747664, 0.0560747664, 0.0...</td>
      <td>[0.046728972, 0.046728972, 0.046728972, 0.0467...</td>
      <td>[0.046728972, 0.046728972, 0.046728972, 0.0467...</td>
    </tr>
    <tr>
      <th>interior_loops</th>
      <td>[0.0280373832, 0.0280373832, 0.0280373832, 0.0...</td>
      <td>[0.009345794400000001, 0.009345794400000001, 0...</td>
      <td>[0.018691588800000002, 0.018691588800000002, 0...</td>
      <td>[0.018691588800000002, 0.018691588800000002, 0...</td>
      <td>[0.0280373832, 0.0280373832, 0.0280373832, 0.0...</td>
    </tr>
    <tr>
      <th>multiloops</th>
      <td>[0.018691588800000002, 0.018691588800000002, 0...</td>
      <td>[0.018691588800000002, 0.018691588800000002, 0...</td>
      <td>[0.037383177600000005, 0.037383177600000005, 0...</td>
      <td>[0.018691588800000002, 0.018691588800000002, 0...</td>
      <td>[0.009345794400000001, 0.009345794400000001, 0...</td>
    </tr>
    <tr>
      <th>hairpin loops</th>
      <td>[0.0280373832, 0.0280373832, 0.0280373832, 0.0...</td>
      <td>[0.0280373832, 0.0280373832, 0.0280373832, 0.0...</td>
      <td>[0.0280373832, 0.0280373832, 0.0280373832, 0.0...</td>
      <td>[0.0280373832, 0.0280373832, 0.0280373832, 0.0...</td>
      <td>[0.018691588800000002, 0.018691588800000002, 0...</td>
    </tr>
    <tr>
      <th>fiveprimes</th>
      <td>[0.009345794400000001, 0.009345794400000001, 0...</td>
      <td>[0.009345794400000001, 0.009345794400000001, 0...</td>
      <td>[0.009345794400000001, 0.009345794400000001, 0...</td>
      <td>[0.009345794400000001, 0.009345794400000001, 0...</td>
      <td>[0.009345794400000001, 0.009345794400000001, 0...</td>
    </tr>
    <tr>
      <th>threeprimes</th>
      <td>[0.009345794400000001, 0.009345794400000001, 0...</td>
      <td>[0.009345794400000001, 0.009345794400000001, 0...</td>
      <td>[0.009345794400000001, 0.009345794400000001, 0...</td>
      <td>[0.009345794400000001, 0.009345794400000001, 0...</td>
      <td>[0.009345794400000001, 0.009345794400000001, 0...</td>
    </tr>
    <tr>
      <th>A_percent</th>
      <td>[0.4205607477, 0.4205607477, 0.4205607477, 0.4...</td>
      <td>[0.23364485980000002, 0.23364485980000002, 0.2...</td>
      <td>[0.4018691589, 0.4018691589, 0.4018691589, 0.4...</td>
      <td>[0.26168224300000004, 0.26168224300000004, 0.2...</td>
      <td>[0.5420560748000001, 0.5420560748000001, 0.542...</td>
    </tr>
    <tr>
      <th>G_percent</th>
      <td>[0.1775700935, 0.1775700935, 0.1775700935, 0.1...</td>
      <td>[0.308411215, 0.308411215, 0.308411215, 0.3084...</td>
      <td>[0.2242990654, 0.2242990654, 0.2242990654, 0.2...</td>
      <td>[0.3271028037, 0.3271028037, 0.3271028037, 0.3...</td>
      <td>[0.0560747664, 0.0560747664, 0.0560747664, 0.0...</td>
    </tr>
    <tr>
      <th>C_percent</th>
      <td>[0.214953271, 0.214953271, 0.214953271, 0.2149...</td>
      <td>[0.2990654206, 0.2990654206, 0.2990654206, 0.2...</td>
      <td>[0.1869158879, 0.1869158879, 0.1869158879, 0.1...</td>
      <td>[0.3271028037, 0.3271028037, 0.3271028037, 0.3...</td>
      <td>[0.0560747664, 0.0560747664, 0.0560747664, 0.0...</td>
    </tr>
    <tr>
      <th>U_percent</th>
      <td>[0.1869158879, 0.1869158879, 0.1869158879, 0.1...</td>
      <td>[0.1588785047, 0.1588785047, 0.1588785047, 0.1...</td>
      <td>[0.1869158879, 0.1869158879, 0.1869158879, 0.1...</td>
      <td>[0.0841121495, 0.0841121495, 0.0841121495, 0.0...</td>
      <td>[0.3457943925, 0.3457943925, 0.3457943925, 0.3...</td>
    </tr>
    <tr>
      <th>U-G</th>
      <td>[0.0869565217, 0.0869565217, 0.0869565217, 0.0...</td>
      <td>[0.030303030300000002, 0.030303030300000002, 0...</td>
      <td>[0.0416666667, 0.0416666667, 0.0416666667, 0.0...</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
    </tr>
    <tr>
      <th>C-G</th>
      <td>[0.1304347826, 0.1304347826, 0.1304347826, 0.1...</td>
      <td>[0.3636363636, 0.3636363636, 0.3636363636, 0.3...</td>
      <td>[0.2083333333, 0.2083333333, 0.2083333333, 0.2...</td>
      <td>[0.4375, 0.4375, 0.4375, 0.4375, 0.4375, 0.437...</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
    </tr>
    <tr>
      <th>U-A</th>
      <td>[0.2608695652, 0.2608695652, 0.2608695652, 0.2...</td>
      <td>[0.030303030300000002, 0.030303030300000002, 0...</td>
      <td>[0.2083333333, 0.2083333333, 0.2083333333, 0.2...</td>
      <td>[0.0625, 0.0625, 0.0625, 0.0625, 0.0625, 0.062...</td>
      <td>[0.4571428571, 0.4571428571, 0.4571428571, 0.4...</td>
    </tr>
    <tr>
      <th>G-C</th>
      <td>[0.347826087, 0.347826087, 0.347826087, 0.3478...</td>
      <td>[0.3939393939, 0.3939393939, 0.3939393939, 0.3...</td>
      <td>[0.2916666667, 0.2916666667, 0.2916666667, 0.2...</td>
      <td>[0.40625000000000006, 0.40625000000000006, 0.4...</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
    </tr>
    <tr>
      <th>A-U</th>
      <td>[0.1739130435, 0.1739130435, 0.1739130435, 0.1...</td>
      <td>[0.12121212120000001, 0.12121212120000001, 0.1...</td>
      <td>[0.125, 0.125, 0.125, 0.125, 0.125, 0.125, 0.1...</td>
      <td>[0.03125, 0.03125, 0.03125, 0.03125, 0.03125, ...</td>
      <td>[0.5428571429, 0.5428571429, 0.5428571429, 0.5...</td>
    </tr>
    <tr>
      <th>G-U</th>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>[0.060606060600000004, 0.060606060600000004, 0...</td>
      <td>[0.125, 0.125, 0.125, 0.125, 0.125, 0.125, 0.1...</td>
      <td>[0.0625, 0.0625, 0.0625, 0.0625, 0.0625, 0.062...</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
    </tr>
    <tr>
      <th>E</th>
      <td>[0.24299065420000002, 0.24299065420000002, 0.2...</td>
      <td>[0.24299065420000002, 0.24299065420000002, 0.2...</td>
      <td>[0.24299065420000002, 0.24299065420000002, 0.2...</td>
      <td>[0.2523364486, 0.2523364486, 0.2523364486, 0.2...</td>
      <td>[0.24299065420000002, 0.24299065420000002, 0.2...</td>
    </tr>
    <tr>
      <th>S</th>
      <td>[0.4299065421, 0.4299065421, 0.4299065421, 0.4...</td>
      <td>[0.6168224299, 0.6168224299, 0.6168224299, 0.6...</td>
      <td>[0.4485981308, 0.4485981308, 0.4485981308, 0.4...</td>
      <td>[0.5981308411, 0.5981308411, 0.5981308411, 0.5...</td>
      <td>[0.6542056075, 0.6542056075, 0.6542056075, 0.6...</td>
    </tr>
    <tr>
      <th>H</th>
      <td>[0.14018691590000001, 0.14018691590000001, 0.1...</td>
      <td>[0.1028037383, 0.1028037383, 0.1028037383, 0.1...</td>
      <td>[0.14018691590000001, 0.14018691590000001, 0.1...</td>
      <td>[0.13084112150000002, 0.13084112150000002, 0.1...</td>
      <td>[0.0747663551, 0.0747663551, 0.0747663551, 0.0...</td>
    </tr>
    <tr>
      <th>B</th>
      <td>[0.009345794400000001, 0.009345794400000001, 0...</td>
      <td>[0.009345794400000001, 0.009345794400000001, 0...</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>[0.018691588800000002, 0.018691588800000002, 0...</td>
      <td>[0.0280373832, 0.0280373832, 0.0280373832, 0.0...</td>
    </tr>
    <tr>
      <th>X</th>
      <td>[0.046728972, 0.046728972, 0.046728972, 0.0467...</td>
      <td>[0.0280373832, 0.0280373832, 0.0280373832, 0.0...</td>
      <td>[0.009345794400000001, 0.009345794400000001, 0...</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
    </tr>
    <tr>
      <th>I</th>
      <td>[0.13084112150000002, 0.13084112150000002, 0.1...</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>[0.1121495327, 0.1121495327, 0.1121495327, 0.1...</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
    </tr>
    <tr>
      <th>M</th>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>[0.046728972, 0.046728972, 0.046728972, 0.0467...</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
    </tr>
    <tr>
      <th>pair_map</th>
      <td>[-1.0, -1.0, -1.0, -1.0, -1.0, 0.2242990654, 0...</td>
      <td>[-1.0, -1.0, -1.0, -1.0, -1.0, 0.5140186916, 0...</td>
      <td>[-1.0, -1.0, -1.0, -1.0, -1.0, 0.6168224299, 0...</td>
      <td>[-1.0, -1.0, -1.0, -1.0, -1.0, -1.0, 0.4018691...</td>
      <td>[-1.0, -1.0, -1.0, -1.0, -1.0, 0.6261682243000...</td>
    </tr>
    <tr>
      <th>pair_distance</th>
      <td>[-1.0, -1.0, -1.0, -1.0, -1.0, 0.1775700935, 0...</td>
      <td>[-1.0, -1.0, -1.0, -1.0, -1.0, 0.4672897196000...</td>
      <td>[-1.0, -1.0, -1.0, -1.0, -1.0, 0.5700934579, 0...</td>
      <td>[-1.0, -1.0, -1.0, -1.0, -1.0, -1.0, 0.3457943...</td>
      <td>[-1.0, -1.0, -1.0, -1.0, -1.0, 0.5794392523, 0...</td>
    </tr>
    <tr>
      <th>BPPS_Max</th>
      <td>[0.021785699999999998, 0.0386527, 0.0275903999...</td>
      <td>[0.1193148348, 0.0808186532, 0.0663817154, 0.0...</td>
      <td>[0.0173400435, 0.0082656658, 0.0078466106, 0.0...</td>
      <td>[0.0350158, 0.033229499999999995, 0.00272567, ...</td>
      <td>[0.0223006011, 0.0522742234, 0.0520811939, 0.0...</td>
    </tr>
    <tr>
      <th>BPPS_nb</th>
      <td>[2.0659663786, 1.2272143578, -0.34544568140000...</td>
      <td>[0.4933063395, 0.4933063395, -0.34544568140000...</td>
      <td>[2.2756543838, 2.5901863917, 0.8078383473, 0.4...</td>
      <td>[0.5981503421000001, 0.9126823499000001, -0.65...</td>
      <td>[0.5981503421000001, 0.8078383473, 0.178774331...</td>
    </tr>
    <tr>
      <th>BPPS_sum</th>
      <td>[0.19854229, 0.1837122, 0.0600024, 0.01312221,...</td>
      <td>[0.168836276, 0.1067594006, 0.0676473022000000...</td>
      <td>[0.0668072416, 0.0443374869, 0.0203303692, 0.0...</td>
      <td>[0.22702912, 0.18439387000000002, 0.0039987999...</td>
      <td>[0.0403607546, 0.0802164279, 0.076875414, 0.07...</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="preprocessing">
<h2>3. Preprocessing<a class="headerlink" href="#preprocessing" title="Permalink to this headline">¬∂</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">target_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;reactivity&#39;</span><span class="p">,</span> <span class="s1">&#39;deg_Mg_pH10&#39;</span><span class="p">,</span> <span class="s1">&#39;deg_pH10&#39;</span><span class="p">,</span> <span class="s1">&#39;deg_Mg_50C&#39;</span><span class="p">,</span> <span class="s1">&#39;deg_50C&#39;</span><span class="p">]</span>
<span class="n">feature_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sequence&#39;</span><span class="p">,</span> <span class="s1">&#39;structure&#39;</span><span class="p">,</span> <span class="s1">&#39;predicted_loop_type&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Filter the train data</span>
<span class="c1"># train = train[train.signal_to_noise&gt;1]</span>
<span class="c1"># train = train[train.SN_filter==1]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># def get_stratify_group(row):</span>
<span class="c1">#     snf = row[&#39;SN_filter&#39;]</span>
<span class="c1">#     snr = row[&#39;signal_to_noise&#39;]</span>
    
<span class="c1">#     if snf == 0:</span>
<span class="c1">#         if snr&lt;0:</span>
<span class="c1">#             snr_c = 0</span>
<span class="c1">#         elif 0&lt;= snr &lt; 2:</span>
<span class="c1">#             snr_c = 1</span>
<span class="c1">#         elif 2&lt;= snr &lt; 4:</span>
<span class="c1">#             snr_c = 2</span>
<span class="c1">#         elif 4&lt;= snr &lt; 5.5:</span>
<span class="c1">#             snr_c = 3</span>
<span class="c1">#         elif 5.5&lt;= snr &lt; 10:</span>
<span class="c1">#             snr_c = 4</span>
<span class="c1">#         elif snr &gt;= 10:</span>
<span class="c1">#             snr_c = 5</span>
            
<span class="c1">#     else: # snf == 1</span>
<span class="c1">#         if snr&lt;2.5:</span>
<span class="c1">#             snr_c = 6</span>
<span class="c1">#         elif 2.5&lt;= snr &lt; 7.5:</span>
<span class="c1">#             snr_c = 7</span>
<span class="c1">#         elif 7.5&lt;= snr &lt; 11:</span>
<span class="c1">#             snr_c = 8</span>
<span class="c1">#         elif snr &gt;= 11:</span>
<span class="c1">#             snr_c = 9</span>
        
<span class="c1">#     return &#39;{}&#39;.format(snr_c)</span>

<span class="k">def</span> <span class="nf">get_stratify_group</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="n">snf</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;SN_filter&#39;</span><span class="p">]</span>
    <span class="n">snr</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;signal_to_noise&#39;</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">snf</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">snr</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">snr_c</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="mi">0</span><span class="o">&lt;=</span> <span class="n">snr</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">snr_c</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="mi">2</span><span class="o">&lt;=</span> <span class="n">snr</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">snr_c</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="mi">4</span><span class="o">&lt;=</span> <span class="n">snr</span> <span class="o">&lt;</span> <span class="mf">5.5</span><span class="p">:</span>
            <span class="n">snr_c</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="k">elif</span> <span class="mf">5.5</span><span class="o">&lt;=</span> <span class="n">snr</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">snr_c</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="k">elif</span> <span class="n">snr</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">snr_c</span> <span class="o">=</span> <span class="mi">5</span>
            
    <span class="k">else</span><span class="p">:</span> <span class="c1"># snf == 1</span>
        <span class="k">if</span> <span class="n">snr</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">snr_c</span> <span class="o">=</span> <span class="mi">6</span>
        <span class="k">elif</span> <span class="mi">2</span><span class="o">&lt;=</span> <span class="n">snr</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">snr_c</span> <span class="o">=</span> <span class="mi">7</span>
        <span class="k">elif</span> <span class="mi">3</span><span class="o">&lt;=</span> <span class="n">snr</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">snr_c</span> <span class="o">=</span> <span class="mi">8</span>
        <span class="k">elif</span> <span class="mi">4</span><span class="o">&lt;=</span> <span class="n">snr</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">snr_c</span> <span class="o">=</span> <span class="mi">9</span>
        <span class="k">elif</span> <span class="mi">5</span><span class="o">&lt;=</span> <span class="n">snr</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
            <span class="n">snr_c</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="k">elif</span> <span class="mi">6</span><span class="o">&lt;=</span> <span class="n">snr</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">:</span>
            <span class="n">snr_c</span> <span class="o">=</span> <span class="mi">11</span>
        <span class="k">elif</span> <span class="mi">7</span><span class="o">&lt;=</span> <span class="n">snr</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
            <span class="n">snr_c</span> <span class="o">=</span> <span class="mi">12</span>
        <span class="k">elif</span> <span class="mi">8</span><span class="o">&lt;=</span> <span class="n">snr</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">:</span>
            <span class="n">snr_c</span> <span class="o">=</span> <span class="mi">13</span>
        <span class="k">elif</span> <span class="mi">9</span><span class="o">&lt;=</span> <span class="n">snr</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">snr_c</span> <span class="o">=</span> <span class="mi">14</span>
        <span class="k">elif</span> <span class="n">snr</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">snr_c</span> <span class="o">=</span> <span class="mi">15</span>
        
    <span class="k">return</span> <span class="n">snr_c</span>


<span class="n">train</span><span class="p">[</span><span class="s1">&#39;snr_stratify_group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">get_stratify_group</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Some new features</span>

<span class="c1"># Next or Prev loop type</span>
<span class="k">def</span> <span class="nf">getNextOrPrevLoop</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">NEXT</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">predicted_loop_type</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s1">&#39;predicted_loop_type&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">NEXT</span><span class="p">:</span>
            <span class="n">predicted_loop_type</span> <span class="o">=</span> <span class="n">predicted_loop_type</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="n">prevLoop</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
        <span class="n">nextLoop</span> <span class="o">=</span> <span class="p">[</span><span class="n">prevLoop</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">predicted_loop_type</span><span class="p">)):</span>
            <span class="n">curr</span> <span class="o">=</span> <span class="n">predicted_loop_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">prev</span> <span class="o">=</span> <span class="n">predicted_loop_type</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="n">curr</span> <span class="o">!=</span> <span class="n">prev</span><span class="p">:</span>
                <span class="n">prevLoop</span> <span class="o">=</span> <span class="n">prev</span>
            
            <span class="n">nextLoop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prevLoop</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">NEXT</span><span class="p">:</span>
            <span class="n">nextLoop</span> <span class="o">=</span> <span class="n">nextLoop</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">nextLoop</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">data</span>


<span class="k">def</span> <span class="nf">getPairedWith</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">bppsData</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">absDistData</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1"># Adjacent pair type</span>
    <span class="n">prevPairData</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">nextPairData</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">sequence</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s1">&#39;sequence&#39;</span><span class="p">]</span>
        <span class="n">structure</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s1">&#39;structure&#39;</span><span class="p">]</span>
        
        <span class="n">bpps</span> <span class="o">=</span> <span class="n">get_bppm</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>

        <span class="n">pairedWith</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#&#39;</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span>
        <span class="n">bpp</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span>
        <span class="n">abs_dist</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span>
        <span class="n">pairIndex</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span>
        
        <span class="n">stack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sequence</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">structure</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;(&#39;</span><span class="p">:</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">structure</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;)&#39;</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                
                <span class="n">pairIndex</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span>
                <span class="n">pairIndex</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
                
                <span class="n">pairedWith</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">sequence</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">pairedWith</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sequence</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                
                <span class="n">bpp</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">bpps</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="n">bpp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">bpps</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
                
                <span class="n">abs_dist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">j</span><span class="p">)</span>
                <span class="n">abs_dist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">j</span><span class="p">)</span>
        
        <span class="n">prevPair</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span>
        <span class="n">nextPair</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sequence</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="o">&gt;=</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">pairIndex</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">prevPair</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">sequence</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">sequence</span><span class="p">[</span><span class="n">pairIndex</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pairIndex</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">nextPair</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">sequence</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">sequence</span><span class="p">[</span><span class="n">pairIndex</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]])</span>
        
        <span class="n">prevPairData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prevPair</span><span class="p">)</span>
        <span class="n">nextPairData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nextPair</span><span class="p">)</span>
        
        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pairedWith</span><span class="p">))</span>
        <span class="n">bppsData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bpp</span><span class="p">)</span>
        <span class="n">absDistData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">abs_dist</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">bppsData</span><span class="p">,</span> <span class="n">absDistData</span><span class="p">,</span> <span class="n">prevPairData</span><span class="p">,</span> <span class="n">nextPairData</span>

<span class="k">def</span> <span class="nf">getBPPFeatures</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="n">maxs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">means</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">argmaxs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sums</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">nonzero</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">bpps</span> <span class="o">=</span> <span class="n">get_bppm</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        
        <span class="n">maxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">bpps</span><span class="p">,</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">bpps</span><span class="p">,</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">argmaxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">bpps</span><span class="p">,</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">sums</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bpps</span><span class="p">,</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">nonzero</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">bpps</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
        
    <span class="k">return</span> <span class="n">maxs</span><span class="p">,</span> <span class="n">means</span><span class="p">,</span> <span class="n">argmaxs</span><span class="p">,</span> <span class="n">sums</span><span class="p">,</span> <span class="n">nonzero</span>

<span class="k">def</span> <span class="nf">getNeighbourBPP</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="n">dataB</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># BPP with Prev Base</span>
    <span class="n">dataA</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># BPP with Next Base</span>
    
    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">bpps</span> <span class="o">=</span> <span class="n">get_bppm</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">seq_length</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">seq_length</span>
        
        <span class="n">B</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">seq_length</span>
        <span class="n">A</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">seq_length</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">seq_length</span><span class="p">):</span>
            
            <span class="k">if</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">bpps</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">&lt;</span><span class="n">seq_length</span><span class="p">:</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">bpps</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            
        <span class="n">dataB</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
        <span class="n">dataA</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">dataB</span><span class="p">,</span> <span class="n">dataA</span>

<span class="c1"># Minimum Pair Distance from Stem-ends</span>
<span class="k">def</span> <span class="nf">getMinPairDist</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">structure</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">structure</span>
        <span class="n">seq_length</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">seq_length</span>
        
        <span class="n">dist</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">seq_length</span>
        
        <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">structure</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;(&#39;</span><span class="p">,</span><span class="s1">&#39;)&#39;</span><span class="p">]:</span>
            <span class="n">dist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">seq_length</span><span class="p">):</span>
            <span class="n">curr</span> <span class="o">=</span> <span class="n">structure</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">curr</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;(&#39;</span><span class="p">,</span><span class="s1">&#39;)&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">curr</span><span class="o">==</span><span class="n">structure</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">a</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">dist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>
        
        <span class="n">structure</span> <span class="o">=</span> <span class="n">structure</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">structure</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;(&#39;</span><span class="p">,</span><span class="s1">&#39;)&#39;</span><span class="p">]:</span>
            <span class="n">dist</span><span class="p">[</span><span class="n">seq_length</span> <span class="o">-</span> <span class="mi">0</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">seq_length</span><span class="p">):</span>
            <span class="n">curr</span> <span class="o">=</span> <span class="n">structure</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">curr</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;(&#39;</span><span class="p">,</span><span class="s1">&#39;)&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">curr</span><span class="o">==</span><span class="n">structure</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">a</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">dist</span><span class="p">[</span><span class="n">seq_length</span> <span class="o">-</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">dist</span><span class="p">[</span><span class="n">seq_length</span> <span class="o">-</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        
        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>
            
    <span class="k">return</span> <span class="n">data</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;https://www.kaggle.com/mrkmakr/covid-ae-pretrain-gnn-attn-cnn&quot;&quot;&quot;</span>

<span class="k">def</span> <span class="nf">return_ohe</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">n</span>
    <span class="n">tmp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">tmp</span>

<span class="k">def</span> <span class="nf">getOHEInput</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    
    <span class="c1">## get node features, which is one hot encoded</span>
    <span class="n">mapping</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">vocab</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;G&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;U&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vocab</span><span class="p">):</span>
        <span class="n">mapping</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">return_ohe</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vocab</span><span class="p">),</span> <span class="n">i</span><span class="p">)</span>
    <span class="n">X_node</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;sequence&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">y</span> <span class="p">:</span> <span class="n">mapping</span><span class="p">[</span><span class="n">y</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">)))))</span>
    
    <span class="k">if</span> <span class="s1">&#39;pairedWith&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">mapping</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">vocab</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;G&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;U&quot;</span><span class="p">,</span> <span class="s2">&quot;#&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vocab</span><span class="p">):</span>
            <span class="n">mapping</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">return_ohe</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vocab</span><span class="p">),</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">X_paired</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;pairedWith&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">y</span> <span class="p">:</span> <span class="n">mapping</span><span class="p">[</span><span class="n">y</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">)))))</span>
        
        <span class="n">X_node</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">X_node</span><span class="p">,</span><span class="n">X_paired</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">mapping</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">vocab</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;M&quot;</span><span class="p">,</span> <span class="s2">&quot;I&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">]</span>
<span class="c1">#     if AUGMENTED:</span>
<span class="c1">#         vocab = [&#39;s&#39;,&#39;h&#39;,&#39;f&#39;,&#39;t&#39;,&#39;i&#39;,&#39;m&#39;]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vocab</span><span class="p">):</span>
        <span class="n">mapping</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">return_ohe</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vocab</span><span class="p">),</span> <span class="n">i</span><span class="p">)</span>
    <span class="n">X_loop</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;predicted_loop_type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">y</span> <span class="p">:</span> <span class="n">mapping</span><span class="p">[</span><span class="n">y</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">)))))</span>
    
    <span class="n">mapping</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">vocab</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;(&quot;</span><span class="p">,</span> <span class="s2">&quot;)&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vocab</span><span class="p">):</span>
        <span class="n">mapping</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">return_ohe</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vocab</span><span class="p">),</span> <span class="n">i</span><span class="p">)</span>
    <span class="n">X_structure</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;structure&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">y</span> <span class="p">:</span> <span class="n">mapping</span><span class="p">[</span><span class="n">y</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">)))))</span>
    
    <span class="n">X_node</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">X_node</span><span class="p">,</span> <span class="n">X_loop</span><span class="p">,</span> <span class="n">X_structure</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
    
    <span class="c1">## interaction</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_node</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">X_node</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">vocab</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">flatten</span><span class="p">()))</span>
    <span class="c1"># print(vocab)</span>
    <span class="n">ohes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vocab</span><span class="p">:</span>
        <span class="n">ohes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">v</span><span class="p">)</span>
    <span class="n">ohes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">ohes</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">X_node</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">X_node</span><span class="p">,</span> <span class="n">ohes</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    
    <span class="c1"># print(X_node.shape)</span>
    
    <span class="k">return</span> <span class="n">X_node</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">s</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;A&#39;</span><span class="p">,</span><span class="s1">&#39;C&#39;</span><span class="p">,</span><span class="s1">&#39;G&#39;</span><span class="p">,</span><span class="s1">&#39;U&#39;</span><span class="p">])</span>
<span class="n">pairTypeDict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">s</span><span class="p">)),</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>

<span class="n">pairTypeDict</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{(&#39;C&#39;, &#39;C&#39;): 0,
 (&#39;C&#39;, &#39;G&#39;): 1,
 (&#39;C&#39;, &#39;A&#39;): 2,
 (&#39;C&#39;, &#39;U&#39;): 3,
 (&#39;G&#39;, &#39;C&#39;): 4,
 (&#39;G&#39;, &#39;G&#39;): 5,
 (&#39;G&#39;, &#39;A&#39;): 6,
 (&#39;G&#39;, &#39;U&#39;): 7,
 (&#39;A&#39;, &#39;C&#39;): 8,
 (&#39;A&#39;, &#39;G&#39;): 9,
 (&#39;A&#39;, &#39;A&#39;): 10,
 (&#39;A&#39;, &#39;U&#39;): 11,
 (&#39;U&#39;, &#39;C&#39;): 12,
 (&#39;U&#39;, &#39;G&#39;): 13,
 (&#39;U&#39;, &#39;A&#39;): 14,
 (&#39;U&#39;, &#39;U&#39;): 15}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">new_features</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">separate_features</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># train[&#39;nextLoopType&#39;] = getNextOrPrevLoop(train)</span>
<span class="c1"># train[&#39;prevLoopType&#39;] = getNextOrPrevLoop(train,NEXT=False)</span>

<span class="c1"># test[&#39;nextLoopType&#39;] = getNextOrPrevLoop(test)</span>
<span class="c1"># test[&#39;prevLoopType&#39;] = getNextOrPrevLoop(test,NEXT=False)</span>

<span class="c1"># new_features += [&#39;nextLoopType&#39;,&#39;prevLoopType&#39;]</span>

<span class="n">train_pw_f</span> <span class="o">=</span> <span class="n">getPairedWith</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>
<span class="n">test_pw_f</span> <span class="o">=</span> <span class="n">getPairedWith</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>

<span class="n">train</span><span class="p">[</span><span class="s1">&#39;pairedWith&#39;</span><span class="p">],</span><span class="n">test</span><span class="p">[</span><span class="s1">&#39;pairedWith&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_pw_f</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">test_pw_f</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">new_features</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;pairedWith&#39;</span><span class="p">]</span>
<span class="n">train</span><span class="p">[</span><span class="s1">&#39;bpp&#39;</span><span class="p">],</span> <span class="n">test</span><span class="p">[</span><span class="s1">&#39;bpp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_pw_f</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">test_pw_f</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="n">separate_features</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;bpp&#39;</span><span class="p">]</span>
<span class="n">train</span><span class="p">[</span><span class="s1">&#39;abs_dist&#39;</span><span class="p">],</span> <span class="n">test</span><span class="p">[</span><span class="s1">&#39;abs_dist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_pw_f</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">test_pw_f</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span> <span class="n">separate_features</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;abs_dist&#39;</span><span class="p">]</span>

<span class="n">feature_cols</span> <span class="o">+=</span> <span class="n">new_features</span>

<span class="n">train_bpp_f</span> <span class="o">=</span> <span class="n">getBPPFeatures</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>
<span class="n">test_bpp_f</span> <span class="o">=</span> <span class="n">getBPPFeatures</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>

<span class="n">train_neighbour_bpp</span> <span class="o">=</span> <span class="n">getNeighbourBPP</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>
<span class="n">test_neighbour_bpp</span> <span class="o">=</span> <span class="n">getNeighbourBPP</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>

<span class="n">train</span><span class="p">[</span><span class="s1">&#39;bpp_maxs&#39;</span><span class="p">],</span> <span class="n">test</span><span class="p">[</span><span class="s1">&#39;bpp_maxs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_bpp_f</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">test_bpp_f</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">separate_features</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;bpp_maxs&#39;</span><span class="p">]</span>
<span class="n">train</span><span class="p">[</span><span class="s1">&#39;bpp_means&#39;</span><span class="p">],</span> <span class="n">test</span><span class="p">[</span><span class="s1">&#39;bpp_means&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_bpp_f</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">test_bpp_f</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="n">separate_features</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;bpp_means&#39;</span><span class="p">]</span>
<span class="c1"># train[&#39;bpp_argmaxs&#39;], test[&#39;bpp_argmaxs&#39;] = train_bpp_f[2], test_bpp_f[2]; separate_features += [&#39;bpp_argmaxs&#39;]</span>
<span class="n">train</span><span class="p">[</span><span class="s1">&#39;bpp_sums&#39;</span><span class="p">],</span> <span class="n">test</span><span class="p">[</span><span class="s1">&#39;bpp_sums&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_bpp_f</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">test_bpp_f</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span> <span class="n">separate_features</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;bpp_sums&#39;</span><span class="p">]</span>

<span class="c1"># train[&#39;bpp_before&#39;], test[&#39;bpp_before&#39;] = train_neighbour_bpp[0], test_neighbour_bpp[0]; separate_features += [&#39;bpp_before&#39;]</span>
<span class="n">train</span><span class="p">[</span><span class="s1">&#39;bpp_after&#39;</span><span class="p">],</span> <span class="n">test</span><span class="p">[</span><span class="s1">&#39;bpp_after&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_neighbour_bpp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">test_neighbour_bpp</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="n">separate_features</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;bpp_after&#39;</span><span class="p">]</span>

<span class="n">train</span><span class="p">[</span><span class="s1">&#39;bpp_nonzero&#39;</span><span class="p">],</span> <span class="n">test</span><span class="p">[</span><span class="s1">&#39;bpp_nonzero&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_bpp_f</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">test_bpp_f</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span> <span class="n">separate_features</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;bpp_nonzero&#39;</span><span class="p">]</span>


<span class="c1"># Adjacent Pair Type</span>
<span class="c1"># train[&#39;prevPairType&#39;], test[&#39;prevPairType&#39;] = train_pw_f[3], test_pw_f[3]; separate_features += [&#39;prevPairType&#39;]</span>
<span class="c1"># train[[&#39;prevPairType&#39;]] = train[[&#39;prevPairType&#39;]].applymap(lambda pairs: [pairTypeDict[pair] if pair!=-1 else -1 for pair in pairs])</span>
<span class="c1"># test[[&#39;prevPairType&#39;]] = test[[&#39;prevPairType&#39;]].applymap(lambda pairs: [pairTypeDict[pair] if pair!=-1 else -1 for pair in pairs])</span>

<span class="c1"># train[&#39;nextPairType&#39;], test[&#39;nextPairType&#39;] = train_pw_f[4], test_pw_f[4]; separate_features += [&#39;nextPairType&#39;]</span>
<span class="c1"># train[[&#39;nextPairType&#39;]] = train[[&#39;nextPairType&#39;]].applymap(lambda pairs: [pairTypeDict[pair] if pair!=-1 else -1 for pair in pairs])</span>
<span class="c1"># test[[&#39;nextPairType&#39;]] = test[[&#39;nextPairType&#39;]].applymap(lambda pairs: [pairTypeDict[pair] if pair!=-1 else -1 for pair in pairs])</span>

<span class="c1"># train[&#39;min_pair_dist_from_stem_end&#39;], test[&#39;min_pair_dist_from_stem_end&#39;] = getMinPairDist(train), getMinPairDist(test); separate_features += [&#39;min_pair_dist_from_stem_end&#39;]</span>

<span class="n">train</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>level_0</th>
      <th>id</th>
      <th>sequence</th>
      <th>structure</th>
      <th>signal_to_noise</th>
      <th>SN_filter</th>
      <th>seq_length</th>
      <th>seq_scored</th>
      <th>reactivity_error</th>
      <th>deg_error_Mg_pH10</th>
      <th>...</th>
      <th>BPPS_sum</th>
      <th>snr_stratify_group</th>
      <th>pairedWith</th>
      <th>bpp</th>
      <th>abs_dist</th>
      <th>bpp_maxs</th>
      <th>bpp_means</th>
      <th>bpp_sums</th>
      <th>bpp_after</th>
      <th>bpp_nonzero</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>id_001f94081</td>
      <td>GGAAAAGCUCUAAUAACAGGAGACUAGGACUACGUAUUUCUAGGUA...</td>
      <td>.....((((((.......)))).)).((.....((..((((((......</td>
      <td>6.894</td>
      <td>1</td>
      <td>107</td>
      <td>68</td>
      <td>[0.1359, 0.20700000000000002, 0.1633, 0.1452, ...</td>
      <td>[0.26130000000000003, 0.38420000000000004, 0.1...</td>
      <td>...</td>
      <td>[0.19854229, 0.1837122, 0.0600024, 0.01312221,...</td>
      <td>7</td>
      <td>#####UCGAGG#######UCUC#GA#CC#####CA##AAGGUC###...</td>
      <td>[-1, -1, -1, -1, -1, 0.069899, 0.114792, 0.356...</td>
      <td>[-1, -1, -1, -1, -1, 19, 17, 14, 12, 10, 8, -1...</td>
      <td>[0.0217857, 0.0386527, 0.0275904, 0.00947066, ...</td>
      <td>[0.0018555354205607479, 0.001716936448598131, ...</td>
      <td>[0.19854229, 0.18371220000000002, 0.0600024000...</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.00529508, 0.0...</td>
      <td>[0.2616822429906542, 0.18691588785046728, 0.04...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>id_0049f53ba</td>
      <td>GGAAAAAGCGCGCGCGGUUAGCGCGCGCUUUUGCGCGCGCUGUACC...</td>
      <td>.....(((((((((((((((((((((((....)))))))))).)))...</td>
      <td>0.193</td>
      <td>0</td>
      <td>107</td>
      <td>68</td>
      <td>[2.8272, 2.8272, 2.8272, 4.7343, 2.5676, 2.567...</td>
      <td>[73705.3985, 73705.3985, 73705.3985, 73705.398...</td>
      <td>...</td>
      <td>[0.168836276, 0.1067594006, 0.0676473022000000...</td>
      <td>1</td>
      <td>#####UUCGCGCGCGCCAGUCGCGCGCG####CGCGCGCGAU#UGG...</td>
      <td>[-1, -1, -1, -1, -1, 0.8560338026180186, 0.980...</td>
      <td>[-1, -1, -1, -1, -1, 50, 48, 46, 44, 42, 40, 3...</td>
      <td>[0.11931483477784201, 0.0808186531761711, 0.06...</td>
      <td>[0.0015779091218742912, 0.0009977514074258377,...</td>
      <td>[0.16883627604054915, 0.10675940059456464, 0.0...</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>[0.12149532710280374, 0.12149532710280374, 0.0...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>id_006f36f57</td>
      <td>GGAAAGUGCUCAGAUAAGCUAAGCUCGAAUAGCAAUCGAAUAGAAU...</td>
      <td>.....((((.((.....((((.(((.....)))..((((......)...</td>
      <td>8.800</td>
      <td>1</td>
      <td>107</td>
      <td>68</td>
      <td>[0.0931, 0.13290000000000002, 0.11280000000000...</td>
      <td>[0.1365, 0.2237, 0.1812, 0.1333, 0.1148, 0.160...</td>
      <td>...</td>
      <td>[0.0668072416, 0.0443374869, 0.0203303692, 0.0...</td>
      <td>8</td>
      <td>#####UAUG#GU#####CGAU#CGA#####UCG##AGCU######A...</td>
      <td>[-1, -1, -1, -1, -1, 0.2826784555573699, 0.298...</td>
      <td>[-1, -1, -1, -1, -1, 61, 59, 57, 55, -1, 51, 4...</td>
      <td>[0.017340043515196805, 0.00826566577930985, 0....</td>
      <td>[0.0006243667443574299, 0.0004143690368910073,...</td>
      <td>[0.06680724164624499, 0.04433748694733778, 0.0...</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>[0.2803738317757009, 0.308411214953271, 0.1495...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
      <td>id_0082d463b</td>
      <td>GGAAAAGCGCGCGCGCGCGCGCGAAAAAGCGCGCGCGCGCGCGCGC...</td>
      <td>......((((((((((((((((......))))))))))))))))((...</td>
      <td>0.104</td>
      <td>0</td>
      <td>107</td>
      <td>68</td>
      <td>[3.5229, 6.0748, 3.0374, 3.0374, 3.0374, 3.037...</td>
      <td>[73705.3985, 73705.3985, 73705.3985, 73705.398...</td>
      <td>...</td>
      <td>[0.22702912, 0.18439387000000002, 0.0039987999...</td>
      <td>1</td>
      <td>######CGCGCGCGCGCGCGCG######CGCGCGCGCGCGCGCGCG...</td>
      <td>[-1, -1, -1, -1, -1, -1, 0.271764, 0.29096, 0....</td>
      <td>[-1, -1, -1, -1, -1, -1, 37, 35, 33, 31, 29, 2...</td>
      <td>[0.0350158, 0.0332295, 0.00272567, 0.0, 0.0, 0...</td>
      <td>[0.002121767476635514, 0.0017233071962616823, ...</td>
      <td>[0.22702912000000003, 0.18439387000000002, 0.0...</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>[0.1308411214953271, 0.1588785046728972, 0.018...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4</td>
      <td>id_0087940f4</td>
      <td>GGAAAAUAUAUAAUAUAUUAUAUAAAUAUAUUAUAGAAGUAUAAUA...</td>
      <td>.....(((((((.((((((((((((.(((((((((....)))))))...</td>
      <td>0.423</td>
      <td>0</td>
      <td>107</td>
      <td>68</td>
      <td>[1.665, 2.1728, 2.0041, 1.2405, 0.620200000000...</td>
      <td>[4.2139, 3.9637000000000002, 3.2467, 2.4716, 1...</td>
      <td>...</td>
      <td>[0.0403607546, 0.0802164279, 0.076875414, 0.07...</td>
      <td>1</td>
      <td>#####UAUAUAU#AUAUAAUAUAUU#AUAUAAUAU####AUAUUAU...</td>
      <td>[-1, -1, -1, -1, -1, 0.494291722659322, 0.7353...</td>
      <td>[-1, -1, -1, -1, -1, 62, 60, 58, 56, 54, 52, 5...</td>
      <td>[0.02230060114516417, 0.052274223411953764, 0....</td>
      <td>[0.00037720331356832457, 0.0007496862422422686...</td>
      <td>[0.04036075455181073, 0.08021642791992274, 0.0...</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>[0.1308411214953271, 0.14953271028037382, 0.09...</td>
    </tr>
  </tbody>
</table>
<p>5 rows √ó 58 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">token2int</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">:</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="s1">&#39;#().ACGUBEHIMSX&#39;</span><span class="p">)}</span>

<span class="c1"># if AUGMENTED:</span>
<span class="c1">#     token2int = {x:i for i, x in enumerate(&#39;#().ACGUshftim&#39;)}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">preprocess_inputs</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="n">feature_cols</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">separate_features</span><span class="p">,</span> <span class="n">token2int</span><span class="o">=</span><span class="n">token2int</span><span class="p">):</span>
    
    <span class="k">if</span> <span class="n">OHE</span><span class="p">:</span>
        <span class="n">X_f</span> <span class="o">=</span> <span class="n">getOHEInput</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">cols</span><span class="p">])</span>
        <span class="n">X_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="n">sep</span><span class="p">]</span>
            <span class="o">.</span><span class="n">values</span>
            <span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="p">),</span>
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">X_f</span><span class="p">,</span> <span class="n">X_s</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        
        
    <span class="n">df1</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">applymap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">seq</span><span class="p">:</span> <span class="p">[</span><span class="n">token2int</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">seq</span><span class="p">])</span>
    
    <span class="n">df2</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">sep</span><span class="p">]</span> 
    
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df1</span><span class="p">,</span><span class="n">df2</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="o">.</span><span class="n">values</span>
            <span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="p">),</span>
        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X</span> <span class="o">=</span> <span class="n">preprocess_inputs</span><span class="p">(</span><span class="n">train</span><span class="p">,</span><span class="n">feature_cols</span><span class="p">)</span>

<span class="k">if</span> <span class="n">AUGMENTED</span><span class="p">:</span>
    <span class="n">train</span><span class="p">[</span><span class="n">target_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="n">target_cols</span><span class="p">]</span><span class="o">.</span><span class="n">applymap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">))</span>

<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="n">target_cols</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Shape of X: &quot;</span><span class="p">,</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Shape of y: &quot;</span><span class="p">,</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Shape of X:  (3948, 107, 11)
Shape of y:  (3948, 68, 5)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">public_df</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;seq_length == 107&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">private_df</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;seq_length == 130&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="n">X_public</span> <span class="o">=</span> <span class="n">preprocess_inputs</span><span class="p">(</span><span class="n">public_df</span><span class="p">,</span><span class="n">feature_cols</span><span class="p">)</span>
<span class="n">X_private</span> <span class="o">=</span> <span class="n">preprocess_inputs</span><span class="p">(</span><span class="n">private_df</span><span class="p">,</span><span class="n">feature_cols</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Public Test size: &quot;</span><span class="p">,</span><span class="n">X_public</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Private Test size: &quot;</span><span class="p">,</span><span class="n">X_private</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="k">assert</span> <span class="n">X_public</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="s2">&quot;Train &amp; Test features shape not same&quot;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Public Test size:  (629, 107, 11)
Private Test size:  (3005, 130, 11)
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="model">
<h2>4. Model<a class="headerlink" href="#model" title="Permalink to this headline">¬∂</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">tpu</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">distribute</span><span class="o">.</span><span class="n">cluster_resolver</span><span class="o">.</span><span class="n">TPUClusterResolver</span><span class="p">()</span> <span class="c1"># TPU detection</span>
    
<span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
    <span class="n">tpu</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1">#If TPU not found try with GPUs</span>
    <span class="n">gpus</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">list_logical_devices</span><span class="p">(</span><span class="s2">&quot;GPU&quot;</span><span class="p">)</span>
    
<span class="c1"># Select appropriate distribution strategy for hardware</span>
<span class="k">if</span> <span class="n">tpu</span><span class="p">:</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">experimental_connect_to_cluster</span><span class="p">(</span><span class="n">tpu</span><span class="p">)</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">tpu</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">initialize_tpu_system</span><span class="p">(</span><span class="n">tpu</span><span class="p">)</span>
    <span class="n">strategy</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">distribute</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">TPUStrategy</span><span class="p">(</span><span class="n">tpu</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Running on TPU &#39;</span><span class="p">,</span> <span class="n">tpu</span><span class="o">.</span><span class="n">master</span><span class="p">())</span>  
    
<span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">gpus</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">strategy</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">distribute</span><span class="o">.</span><span class="n">MirroredStrategy</span><span class="p">(</span><span class="n">gpus</span><span class="p">)</span> <span class="c1"># this works for 1 to multiple GPUs</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Running on &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">gpus</span><span class="p">),</span> <span class="s1">&#39; GPU(s) &#39;</span><span class="p">)</span>

<span class="k">else</span><span class="p">:</span>
    <span class="n">strategy</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">distribute</span><span class="o">.</span><span class="n">get_strategy</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Running on CPU&#39;</span><span class="p">)</span>

<span class="c1"># How many accelerators do we have ?</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of accelerators: &quot;</span><span class="p">,</span> <span class="n">strategy</span><span class="o">.</span><span class="n">num_replicas_in_sync</span><span class="p">)</span>
    
<span class="n">AUTO</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">AUTOTUNE</span>
<span class="n">REPLICAS</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">num_replicas_in_sync</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Running on  1  GPU(s) 
Number of accelerators:  1
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">FOLDS</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">EPOCHS</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">32</span>
<span class="n">VERBOSE</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">LR</span> <span class="o">=</span> <span class="mf">0.00004</span>
<span class="n">WARMUP</span> <span class="o">=</span> <span class="mi">5</span>

<span class="n">CYCLIC_LRS</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">CYCLIC_BLR</span> <span class="o">=</span> <span class="mf">1e-3</span>
<span class="n">CYCLIC_MLR</span> <span class="o">=</span> <span class="mf">8e-3</span>
<span class="n">CYCLIC_STEP</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">FOLDS</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">FOLDS</span><span class="o">*</span><span class="n">BATCH_SIZE</span><span class="p">))</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cyclic Step: &quot;</span><span class="p">,</span><span class="n">CYCLIC_STEP</span><span class="p">)</span>

<span class="n">EXPDECAY_LRS</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">EXP_LRSTART</span> <span class="o">=</span> <span class="mf">5e-3</span>
<span class="n">EXP_LRMAX</span> <span class="o">=</span> <span class="mf">1.25e-2</span>
<span class="n">EXP_LRMIN</span> <span class="o">=</span> <span class="mf">1e-3</span>
<span class="n">EXP_RAMPUP</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">EXP_SUSTAIN</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">EXP_DECAY</span> <span class="o">=</span> <span class="mf">0.8</span>

<span class="n">INFER_TEST</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">DISPLAY_PLOT</span> <span class="o">=</span> <span class="kc">True</span>

<span class="n">DROPOUT</span> <span class="o">=</span> <span class="mf">0.4</span>
<span class="n">EMBED_DIM</span> <span class="o">=</span> <span class="mi">100</span>

<span class="n">TRANSFORMERS</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">SKF_SNR</span> <span class="o">=</span> <span class="kc">True</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Replicas: &quot;</span><span class="p">,</span><span class="n">REPLICAS</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cyclic Step:  789
Replicas:  1
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Gaussian Noise</span>
<span class="n">P</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="k">def</span> <span class="nf">add_noise</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
    
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="kc">True</span><span class="p">,</span><span class="kc">False</span><span class="p">],</span><span class="n">p</span><span class="o">=</span><span class="p">[</span><span class="n">P</span><span class="p">,</span><span class="mi">1</span><span class="o">-</span><span class="n">P</span><span class="p">]):</span>
        <span class="n">y</span> <span class="o">+=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span><span class="n">seed</span><span class="o">=</span><span class="n">SEED</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">getTrainGenerator</span><span class="p">(</span><span class="n">X_</span><span class="p">,</span><span class="n">y_</span><span class="p">):</span>
    <span class="n">traindata_generator</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_tensor_slices</span><span class="p">((</span><span class="n">X_</span><span class="p">,</span><span class="n">y_</span><span class="p">))</span>
        <span class="o">.</span><span class="n">cache</span><span class="p">()</span>
        <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">add_noise</span><span class="p">,</span><span class="n">num_parallel_calls</span><span class="o">=</span><span class="n">AUTO</span><span class="p">)</span>
        <span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">BATCH_SIZE</span><span class="o">*</span><span class="n">REPLICAS</span><span class="p">)</span>
        <span class="o">.</span><span class="n">prefetch</span><span class="p">(</span><span class="n">AUTO</span><span class="p">)</span>
    <span class="p">)</span>
    
    <span class="k">return</span> <span class="n">traindata_generator</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">rmse</span><span class="p">(</span><span class="n">y_actual</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
    <span class="n">mse</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_actual</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">K</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mse</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">mcrmse</span><span class="p">(</span><span class="n">y_actual</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">num_scored</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">target_cols</span><span class="p">)):</span>
    <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_scored</span><span class="p">):</span>
        <span class="n">score</span> <span class="o">+=</span> <span class="n">rmse</span><span class="p">(</span><span class="n">y_actual</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">y_pred</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="n">num_scored</span>
    <span class="k">return</span> <span class="n">score</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="positional-encoding">
<h3>Positional Encoding<a class="headerlink" href="#positional-encoding" title="Permalink to this headline">¬∂</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_angles</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">d_model</span><span class="p">):</span>
    <span class="n">angle_rates</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span><span class="o">//</span><span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">d_model</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">pos</span> <span class="o">*</span> <span class="n">angle_rates</span>


<span class="k">def</span> <span class="nf">positional_encoding</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">d_model</span><span class="p">):</span>
    <span class="n">angle_rads</span> <span class="o">=</span> <span class="n">get_angles</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">position</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">d_model</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span> <span class="n">d_model</span><span class="p">)</span>
    
    <span class="c1"># apply sin to even indices in the array; 2i</span>
    <span class="n">angle_rads</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle_rads</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">])</span>
    
    <span class="c1"># apply cos to odd indices in the array; 2i+1</span>
    <span class="n">angle_rads</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle_rads</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">pos_encoding</span> <span class="o">=</span> <span class="n">angle_rads</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">pos_encoding</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="multiheaded-attention">
<h3>Multiheaded Attention<a class="headerlink" href="#multiheaded-attention" title="Permalink to this headline">¬∂</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MultiHeadAttention</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Layer</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d_model</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span> <span class="n">num_heads</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="n">causal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MultiHeadAttention</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="k">assert</span> <span class="n">d_model</span> <span class="o">%</span> <span class="n">num_heads</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="n">d_model</span> <span class="o">//</span> <span class="n">num_heads</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">w_query</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">d_model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">split_reshape_query</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">num_heads</span><span class="p">,</span><span class="n">depth</span><span class="p">))</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">split_permute_query</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Permute</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>      

        <span class="bp">self</span><span class="o">.</span><span class="n">w_value</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">d_model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">split_reshape_value</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">num_heads</span><span class="p">,</span><span class="n">depth</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">split_permute_value</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Permute</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">w_key</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">d_model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">split_reshape_key</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">num_heads</span><span class="p">,</span><span class="n">depth</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">split_permute_key</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Permute</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">attention</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Attention</span><span class="p">(</span><span class="n">causal</span><span class="o">=</span><span class="n">causal</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="n">dropout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">join_permute_attention</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Permute</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">join_reshape_attention</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">d_model</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dense</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">d_model</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="n">v</span>

        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_query</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_reshape_query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>    
        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_permute_query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>                 

        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_value</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_reshape_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_permute_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_key</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_reshape_key</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_permute_key</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))(</span><span class="n">mask</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Permute</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))(</span><span class="n">mask</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">mask</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">mask</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))(</span><span class="n">mask</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">mask</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Permute</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))(</span><span class="n">mask</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">attention</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attention</span><span class="p">([</span><span class="n">query</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">key</span><span class="p">],</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
        <span class="n">attention</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">join_permute_attention</span><span class="p">(</span><span class="n">attention</span><span class="p">)</span>
        <span class="n">attention</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">join_reshape_attention</span><span class="p">(</span><span class="n">attention</span><span class="p">)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dense</span><span class="p">(</span><span class="n">attention</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">x</span>
    
    <span class="k">def</span> <span class="nf">get_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">config</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_config</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s1">&#39;w_q&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_query</span><span class="p">,</span>
            <span class="s1">&#39;s_r_q&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">split_reshape_query</span><span class="p">,</span> 
            <span class="s1">&#39;s_p_q&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">split_permute_query</span><span class="p">,</span>
            
            <span class="s1">&#39;w_v&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">w_value</span><span class="p">,</span>
            <span class="s1">&#39;s_r_v&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">split_reshape_value</span><span class="p">,</span>
            <span class="s1">&#39;s_p_v&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">split_permute_value</span><span class="p">,</span>

            <span class="s1">&#39;w_k&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">w_key</span><span class="p">,</span>
            <span class="s1">&#39;s_r_k&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">split_reshape_key</span><span class="p">,</span>
            <span class="s1">&#39;s_p_k&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">split_permute_key</span><span class="p">,</span>

            <span class="s1">&#39;attn&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">attention</span><span class="p">,</span>
            <span class="s1">&#39;p_attn&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">join_permute_attention</span><span class="p">,</span>
            <span class="s1">&#39;r_attn&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">join_reshape_attention</span><span class="p">,</span>

            <span class="s1">&#39;dense&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">dense</span>
        <span class="p">})</span>
        
        <span class="k">return</span> <span class="n">config</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="encoder-layer">
<h3>Encoder-Layer<a class="headerlink" href="#encoder-layer" title="Permalink to this headline">¬∂</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">EncoderLayer</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Layer</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">d_model</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span> <span class="n">num_heads</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="n">dff</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">,</span> <span class="n">dropout</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">EncoderLayer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">multi_head_attention</span> <span class="o">=</span>  <span class="n">MultiHeadAttention</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">num_heads</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout_attention</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_attention</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Add</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer_norm_attention</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">LayerNormalization</span><span class="p">(</span><span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dense1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">dff</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dense2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">d_model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout_dense</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_dense</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Add</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer_norm_dense</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">LayerNormalization</span><span class="p">(</span><span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># print(mask)</span>
        <span class="n">attention</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">multi_head_attention</span><span class="p">([</span><span class="n">inputs</span><span class="p">,</span><span class="n">inputs</span><span class="p">,</span><span class="n">inputs</span><span class="p">],</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="n">mask</span><span class="p">,</span><span class="n">mask</span><span class="p">])</span>
        <span class="n">attention</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout_attention</span><span class="p">(</span><span class="n">attention</span><span class="p">,</span> <span class="n">training</span> <span class="o">=</span> <span class="n">training</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_attention</span><span class="p">([</span><span class="n">inputs</span> <span class="p">,</span> <span class="n">attention</span><span class="p">])</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_norm_attention</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="c1"># x = inputs</span>

        <span class="c1">## Feed Forward</span>
        <span class="n">dense</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dense1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">dense</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dense2</span><span class="p">(</span><span class="n">dense</span><span class="p">)</span>
        <span class="n">dense</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout_dense</span><span class="p">(</span><span class="n">dense</span><span class="p">,</span> <span class="n">training</span> <span class="o">=</span> <span class="n">training</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_dense</span><span class="p">([</span><span class="n">x</span> <span class="p">,</span> <span class="n">dense</span><span class="p">])</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_norm_dense</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">x</span>

    <span class="k">def</span> <span class="nf">get_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">config</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_config</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s1">&#39;mha&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">multi_head_attention</span><span class="p">,</span>
            <span class="s1">&#39;drop_attn&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout_attention</span><span class="p">,</span>
            <span class="s1">&#39;add_attn&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_attention</span><span class="p">,</span>
            <span class="s1">&#39;ln_attn&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_norm_attention</span><span class="p">,</span>
            <span class="s1">&#39;dense1&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dense1</span><span class="p">,</span>
            <span class="s1">&#39;dense2&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dense2</span><span class="p">,</span>
            <span class="s1">&#39;drop_dense&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout_dense</span><span class="p">,</span>
            <span class="s1">&#39;add_dense&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_dense</span><span class="p">,</span>
            <span class="s1">&#39;ln_dense&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_norm_dense</span>
        <span class="p">})</span>
        
        <span class="k">return</span> <span class="n">config</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="gru-lstms">
<h3>GRU-LSTMs<a class="headerlink" href="#gru-lstms" title="Permalink to this headline">¬∂</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">gru_layer</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">dropout</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Bidirectional</span><span class="p">(</span>
                                <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">GRU</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span>
                                <span class="n">dropout</span><span class="o">=</span><span class="n">dropout</span><span class="p">,</span>
                                <span class="n">return_sequences</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">kernel_initializer</span><span class="o">=</span><span class="s1">&#39;orthogonal&#39;</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">lstm_layer</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">dropout</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Bidirectional</span><span class="p">(</span>
                                <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span>
                                <span class="n">dropout</span><span class="o">=</span><span class="n">dropout</span><span class="p">,</span>
                                <span class="n">return_sequences</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">kernel_initializer</span><span class="o">=</span><span class="s1">&#39;orthogonal&#39;</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">res</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">kernel</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">rate</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">):</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv1D</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">padding</span> <span class="o">=</span> <span class="s2">&quot;same&quot;</span><span class="p">,</span> <span class="n">activation</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">LayerNormalization</span><span class="p">()(</span><span class="n">h</span><span class="p">)</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">()(</span><span class="n">h</span><span class="p">)</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">rate</span><span class="p">)(</span><span class="n">h</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Add</span><span class="p">()([</span><span class="n">x</span><span class="p">,</span> <span class="n">h</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">kernel</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">rate</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">):</span>
<span class="c1">#     h = L.Dense(unit, None)(x)</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv1D</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">padding</span> <span class="o">=</span> <span class="s2">&quot;same&quot;</span><span class="p">,</span> <span class="n">activation</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">LayerNormalization</span><span class="p">()(</span><span class="n">h</span><span class="p">)</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">rate</span><span class="p">)(</span><span class="n">h</span><span class="p">)</span>
<span class="c1">#         h = tf.keras.activations.swish(h)</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">()(</span><span class="n">h</span><span class="p">)</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">res</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">rate</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">h</span>


<span class="k">def</span> <span class="nf">build_model</span><span class="p">(</span><span class="n">seq_len</span><span class="o">=</span><span class="mi">107</span><span class="p">,</span> <span class="n">pred_len</span><span class="o">=</span><span class="mi">68</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="n">DROPOUT</span><span class="p">,</span>
                <span class="n">embed_dim</span><span class="o">=</span><span class="n">EMBED_DIM</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="o">=</span><span class="mi">128</span><span class="p">):</span>
    
    <span class="n">inputs</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">seq_len</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    
    <span class="n">fs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">feature_cols</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">OHE</span><span class="p">:</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">separate_features</span><span class="p">)</span>
<span class="c1">#         conv1 = forward(inputs[:,:,:fs], 256, 3, 0.0)</span>
        <span class="n">conv1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv1D</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;elu&#39;</span><span class="p">)(</span><span class="n">inputs</span><span class="p">[:,:,:</span><span class="n">fs</span><span class="p">])</span>
<span class="c1">#         conv2 = tf.keras.layers.Conv1D(128, 6, padding=&#39;same&#39;, activation=&#39;elu&#39;)(conv1)</span>
<span class="c1">#         conv3 = tf.keras.layers.Conv1D(32, 12, padding=&#39;same&#39;, activation=&#39;elu&#39;)(conv2)</span>
<span class="c1">#         conv4 = tf.keras.layers.Conv1D(16, 24, padding=&#39;same&#39;, activation=&#39;elu&#39;)(conv3)</span>
<span class="c1">#         hidden = tf.keras.layers.Concatenate(axis=-1)([conv1,conv2])</span>
        <span class="n">hidden</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">SpatialDropout1D</span><span class="p">(</span><span class="o">.</span><span class="mi">2</span><span class="p">)(</span><span class="n">conv1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">embed</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">input_dim</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">token2int</span><span class="p">),</span> <span class="n">output_dim</span><span class="o">=</span><span class="n">embed_dim</span><span class="p">)(</span><span class="n">inputs</span><span class="p">[:,:,:</span><span class="n">fs</span><span class="p">])</span>
        <span class="n">reshaped</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">embed</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">embed</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">embed</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">embed</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
        <span class="n">hidden</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">SpatialDropout1D</span><span class="p">(</span><span class="o">.</span><span class="mi">2</span><span class="p">)(</span><span class="n">reshaped</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">separate_features</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">hidden</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Concatenate</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)([</span><span class="n">hidden</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">inputs</span><span class="p">[:,:,</span><span class="n">fs</span><span class="p">:],</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">hidden</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Concatenate</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)([</span><span class="n">hidden</span><span class="p">,</span><span class="n">inputs</span><span class="p">[:,:,</span><span class="n">fs</span><span class="p">:]])</span>
    
<span class="c1">#     conv1 = forward(hidden, 256, 3, 0.0)</span>
    <span class="n">conv1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv1D</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;elu&#39;</span><span class="p">)(</span><span class="n">hidden</span><span class="p">)</span>
    
    <span class="n">hidden</span> <span class="o">=</span> <span class="n">gru_layer</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">dropout</span><span class="p">)(</span><span class="n">conv1</span><span class="p">)</span>
    
    <span class="n">hidden</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Concatenate</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)([</span><span class="n">hidden</span><span class="p">,</span><span class="n">conv1</span><span class="p">])</span>
    
<span class="c1">#     hidden = gru_layer(hidden_dim, dropout)(hidden)</span>
    
<span class="c1">#     hidden = gru_layer(hidden_dim, dropout)(hidden)</span>
<span class="c1">#     hidden = gru_layer(hidden_dim, dropout)(hidden)</span>
    
    
    <span class="n">hidden</span> <span class="o">=</span> <span class="n">gru_layer</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">dropout</span><span class="p">)(</span><span class="n">hidden</span><span class="p">)</span>
    <span class="n">hidden</span> <span class="o">=</span> <span class="n">gru_layer</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">dropout</span><span class="p">)(</span><span class="n">hidden</span><span class="p">)</span>
<span class="c1">#     hidden = lstm_layer(hidden_dim, dropout)(hidden)</span>

    <span class="c1"># BLOCK 1</span>
<span class="c1">#     hidden_1 = gru_layer(hidden_dim, dropout)(hidden)</span>
<span class="c1">#     hidden_1 = gru_layer(hidden_dim, dropout)(hidden_1)</span>
<span class="c1">#     hidden_1 = gru_layer(hidden_dim, dropout)(hidden_1)</span>
        
    <span class="c1"># BLOCK 2</span>
<span class="c1">#     hidden_2 = lstm_layer(hidden_dim, dropout)(hidden)</span>
<span class="c1">#     hidden_2 = lstm_layer(hidden_dim, dropout)(hidden_2)</span>
<span class="c1">#     hidden_2 = lstm_layer(hidden_dim, dropout)(hidden_2)</span>
        
    <span class="c1"># BLOCK 3</span>
<span class="c1">#     hidden_3 = gru_layer(hidden_dim, dropout)(hidden)</span>
<span class="c1">#     hidden_3 = lstm_layer(hidden_dim, dropout)(hidden_3)</span>
<span class="c1">#     hidden_3 = gru_layer(hidden_dim, dropout)(hidden_3)</span>
    
    <span class="c1"># BLOCK 4</span>
<span class="c1">#     hidden_4 = lstm_layer(hidden_dim, dropout)(hidden)</span>
<span class="c1">#     hidden_4 = gru_layer(hidden_dim, dropout)(hidden_4)</span>
<span class="c1">#     hidden_4 = lstm_layer(hidden_dim, dropout)(hidden_4)</span>
    
    <span class="c1">#only making predictions on the first part of each sequence</span>
<span class="c1">#     truncated_1 = hidden_1[:, :pred_len]</span>
<span class="c1">#     truncated_2 = hidden_2[:, :pred_len]</span>
<span class="c1">#     truncated_3 = hidden_3[:, :pred_len]</span>
<span class="c1">#     truncated_4 = hidden_4[:, :pred_len]</span>
    
<span class="c1">#     out_1 = tf.keras.layers.Dense(5, activation=&#39;linear&#39;)(truncated_1)</span>
<span class="c1">#     out_2 = tf.keras.layers.Dense(5, activation=&#39;linear&#39;)(truncated_2)</span>
<span class="c1">#     out_3 = tf.keras.layers.Dense(5, activation=&#39;linear&#39;)(truncated_3)</span>
<span class="c1">#     out_4 = tf.keras.layers.Dense(5, activation=&#39;linear&#39;)(truncated_4)</span>
    
<span class="c1">#     out = tf.keras.layers.Concatenate(axis=-1)([truncated_1,truncated_2,truncated_3,truncated_4])</span>
<span class="c1">#     out = tf.keras.layers.Dense(128, activation=&#39;elu&#39;)(out)</span>
<span class="c1">#     out = tf.keras.layers.Dropout(0.4)(out)</span>
    
<span class="c1">#     out = tf.keras.layers.Dense(5, activation=&#39;linear&#39;)(out)</span>

<span class="c1">#     hidden = tf.keras.layers.Conv1D(512, 3, padding=&#39;same&#39;, activation=&#39;elu&#39;)(hidden)</span>
    
    <span class="n">truncated</span> <span class="o">=</span> <span class="n">hidden</span><span class="p">[:,</span> <span class="p">:</span><span class="n">pred_len</span><span class="p">]</span>
    
    <span class="n">out</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)(</span><span class="n">truncated</span><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>

    <span class="c1">#some optimizers</span>
    <span class="n">adam</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">()</span>
    <span class="n">radam</span> <span class="o">=</span> <span class="n">tfa</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">RectifiedAdam</span><span class="p">()</span>
    <span class="n">lookahead</span> <span class="o">=</span> <span class="n">tfa</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Lookahead</span><span class="p">(</span><span class="n">adam</span><span class="p">,</span> <span class="n">sync_period</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
    <span class="n">ranger</span> <span class="o">=</span> <span class="n">tfa</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Lookahead</span><span class="p">(</span><span class="n">radam</span><span class="p">,</span> <span class="n">sync_period</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
    
    <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">adam</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="n">mcrmse</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">model</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="transformers">
<h3>Transformers<a class="headerlink" href="#transformers" title="Permalink to this headline">¬∂</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">build_transformer</span><span class="p">(</span><span class="n">hidden_dim</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span><span class="n">seq_len</span><span class="o">=</span><span class="mi">107</span><span class="p">,</span> <span class="n">pred_len</span><span class="o">=</span><span class="mi">68</span><span class="p">,</span> <span class="n">embed_dim</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">d_model</span> <span class="o">=</span> <span class="mi">128</span><span class="p">,</span> <span class="n">num_heads</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">dff</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span> <span class="n">maximum_position_encoding</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span> <span class="n">dropout</span> <span class="o">=</span> <span class="mf">0.4</span><span class="p">):</span>
    
    <span class="n">inputs</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">seq_len</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    
    <span class="c1"># Input Embeddings</span>
    <span class="n">fs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">feature_cols</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">OHE</span><span class="p">:</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">separate_features</span><span class="p">)</span>
        <span class="n">conv1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv1D</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;elu&#39;</span><span class="p">)(</span><span class="n">inputs</span><span class="p">[:,:,:</span><span class="n">fs</span><span class="p">])</span>
        <span class="n">hidden</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">SpatialDropout1D</span><span class="p">(</span><span class="o">.</span><span class="mi">2</span><span class="p">)(</span><span class="n">conv1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">embed</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">input_dim</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">token2int</span><span class="p">),</span> <span class="n">output_dim</span><span class="o">=</span><span class="n">embed_dim</span><span class="p">)(</span><span class="n">inputs</span><span class="p">[:,:,:</span><span class="n">fs</span><span class="p">])</span>
        <span class="n">reshaped</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">embed</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">embed</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">embed</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">embed</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
        <span class="n">hidden</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">SpatialDropout1D</span><span class="p">(</span><span class="o">.</span><span class="mi">2</span><span class="p">)(</span><span class="n">reshaped</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">separate_features</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">hidden</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Concatenate</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)([</span><span class="n">hidden</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">inputs</span><span class="p">[:,:,</span><span class="n">fs</span><span class="p">:],</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">hidden</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Concatenate</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)([</span><span class="n">hidden</span><span class="p">,</span><span class="n">inputs</span><span class="p">[:,:,</span><span class="n">fs</span><span class="p">:]])</span>

    <span class="c1"># Input Embeddings</span>
    <span class="c1"># embedding = tf.keras.layers.Embedding(input_dim=len(token2int), output_dim=embed_dim)(inputs[:,:,:len(feature_cols)])</span>
    <span class="c1"># reshaped = tf.reshape(embedding, shape=(-1, embedding.shape[1], embedding.shape[2] * embedding.shape[3]))</span>
    <span class="c1"># hidden = tf.keras.layers.SpatialDropout1D(.2)(reshaped)</span>
    
    <span class="c1"># Numerical Features</span>
<span class="c1">#     if len(separate_features)==1:</span>
<span class="c1">#         hidden = tf.keras.layers.Concatenate(axis=-1)([hidden,tf.keras.backend.expand_dims(inputs[:,:,len(feature_cols):],axis=-1)])</span>
<span class="c1">#     else:</span>
<span class="c1">#         hidden = tf.keras.layers.Concatenate(axis=-1)([hidden,inputs[:,:,len(feature_cols):]])</span>
    
    <span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv1D</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;elu&#39;</span><span class="p">)(</span><span class="n">hidden</span><span class="p">)</span>
    
    <span class="c1"># RNNs</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">gru_layer</span><span class="p">(</span><span class="n">d_model</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">dropout</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">lstm_layer</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">dropout</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">gru_layer</span><span class="p">(</span><span class="n">d_model</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">dropout</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>

    <span class="c1"># Positional Encoding</span>
<span class="c1">#     scaling_factor = tf.keras.backend.constant(np.sqrt(d_model), shape = (1,1,1))</span>
<span class="c1">#     x = tf.keras.layers.Multiply()([x,scaling_factor])</span>
<span class="c1">#     pos = positional_encoding(maximum_position_encoding, d_model)</span>
<span class="c1">#     x = tf.keras.layers.Add()([x, pos[: , :tf.shape(x)[1], :]])</span>
    
    <span class="c1"># Encoding Layers</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">EncoderLayer</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">num_heads</span><span class="p">,</span> <span class="n">dff</span><span class="p">,</span> <span class="n">dropout</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="c1"># x = EncoderLayer(d_model, num_heads, dff, dropout)(x)</span>
    
    <span class="c1"># RNNs</span>
    <span class="c1"># x = gru_layer(d_model//2, dropout)(x)</span>
    <span class="c1"># x = gru_layer(d_model//2, dropout)(x)</span>
    
    <span class="c1"># FFN</span>
    <span class="n">truncated</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,:</span><span class="n">pred_len</span><span class="p">,:]</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="n">activation</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)(</span><span class="n">truncated</span><span class="p">)</span>
    
    <span class="c1"># Model</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>

    <span class="c1"># Optimizers</span>
    <span class="n">adam</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">()</span>
    <span class="n">radam</span> <span class="o">=</span> <span class="n">tfa</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">RectifiedAdam</span><span class="p">()</span>
    <span class="n">lookahead</span> <span class="o">=</span> <span class="n">tfa</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Lookahead</span><span class="p">(</span><span class="n">adam</span><span class="p">,</span> <span class="n">sync_period</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
    <span class="n">ranger</span> <span class="o">=</span> <span class="n">tfa</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Lookahead</span><span class="p">(</span><span class="n">radam</span><span class="p">,</span> <span class="n">sync_period</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
    
    <span class="c1"># Compilation</span>
    <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">adam</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="n">mcrmse</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">model</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="ow">not</span> <span class="n">TRANSFORMERS</span><span class="p">:</span>
    <span class="n">plot</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">plot_model</span><span class="p">(</span><span class="n">build_model</span><span class="p">(),</span><span class="n">show_shapes</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">plot</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">plot_model</span><span class="p">(</span><span class="n">build_transformer</span><span class="p">(),</span><span class="n">show_shapes</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">plot</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/openvaccine-transformers-lstm-gru_38_0.png" src="../_images/openvaccine-transformers-lstm-gru_38_0.png" />
</div>
</div>
</div>
</div>
<div class="section" id="lr-schedulers">
<h2>5. LR Schedulers<a class="headerlink" href="#lr-schedulers" title="Permalink to this headline">¬∂</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_cosine_schedule_with_warmup</span><span class="p">(</span><span class="n">lr</span><span class="p">,</span> <span class="n">num_warmup_steps</span><span class="p">,</span> <span class="n">num_training_steps</span><span class="p">,</span> <span class="n">num_cycles</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Modified version of the get_cosine_schedule_with_warmup from huggingface.</span>
<span class="sd">    (https://huggingface.co/transformers/_modules/transformers/optimization.html#get_cosine_schedule_with_warmup)</span>

<span class="sd">    Create a schedule with a learning rate that decreases following the</span>
<span class="sd">    values of the cosine function between 0 and `pi * cycles` after a warmup</span>
<span class="sd">    period during which it increases linearly between 0 and 1.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">lrfn</span><span class="p">(</span><span class="n">epoch</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">epoch</span> <span class="o">&lt;</span> <span class="n">num_warmup_steps</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_warmup_steps</span><span class="p">)))</span> <span class="o">*</span> <span class="n">lr</span>
        <span class="n">progress</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">epoch</span> <span class="o">-</span> <span class="n">num_warmup_steps</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_training_steps</span> <span class="o">-</span> <span class="n">num_warmup_steps</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">num_cycles</span><span class="p">)</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">progress</span><span class="p">)))</span> <span class="o">*</span> <span class="n">lr</span>

    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">LearningRateScheduler</span><span class="p">(</span><span class="n">lrfn</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">build_lrfn</span><span class="p">(</span><span class="n">lr_start</span><span class="o">=</span><span class="n">EXP_LRSTART</span><span class="p">,</span> <span class="n">lr_max</span><span class="o">=</span><span class="n">EXP_LRMAX</span><span class="p">,</span> 
               <span class="n">lr_min</span><span class="o">=</span><span class="n">EXP_LRMIN</span><span class="p">,</span> <span class="n">lr_rampup_epochs</span><span class="o">=</span><span class="n">EXP_RAMPUP</span><span class="p">,</span> 
               <span class="n">lr_sustain_epochs</span><span class="o">=</span><span class="n">EXP_SUSTAIN</span><span class="p">,</span> <span class="n">lr_exp_decay</span><span class="o">=</span><span class="n">EXP_DECAY</span><span class="p">):</span>
    
    <span class="n">lr_max</span> <span class="o">=</span> <span class="n">lr_max</span> <span class="o">*</span> <span class="n">BATCH_SIZE</span>
    <span class="k">def</span> <span class="nf">lrfn</span><span class="p">(</span><span class="n">epoch</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">epoch</span> <span class="o">&lt;</span> <span class="n">lr_rampup_epochs</span><span class="p">:</span>
            <span class="n">lr</span> <span class="o">=</span> <span class="p">(</span><span class="n">lr_max</span> <span class="o">-</span> <span class="n">lr_start</span><span class="p">)</span> <span class="o">/</span> <span class="n">lr_rampup_epochs</span> <span class="o">*</span> <span class="n">epoch</span> <span class="o">+</span> <span class="n">lr_start</span>
        <span class="k">elif</span> <span class="n">epoch</span> <span class="o">&lt;</span> <span class="n">lr_rampup_epochs</span> <span class="o">+</span> <span class="n">lr_sustain_epochs</span><span class="p">:</span>
            <span class="n">lr</span> <span class="o">=</span> <span class="n">lr_max</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lr</span> <span class="o">=</span> <span class="p">(</span><span class="n">lr_max</span> <span class="o">-</span> <span class="n">lr_min</span><span class="p">)</span> <span class="o">*</span> <span class="n">lr_exp_decay</span><span class="o">**</span><span class="p">(</span><span class="n">epoch</span> <span class="o">-</span> <span class="n">lr_rampup_epochs</span> <span class="o">-</span> <span class="n">lr_sustain_epochs</span><span class="p">)</span> <span class="o">+</span> <span class="n">lr_min</span>
        
        <span class="k">return</span> <span class="n">lr</span>
    
    <span class="k">return</span> <span class="n">lrfn</span>


<span class="k">class</span> <span class="nc">CyclicLR</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">Callback</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">base_lr</span><span class="o">=</span><span class="mf">0.25e-3</span><span class="p">,</span><span class="n">max_lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span><span class="n">stepsize</span><span class="o">=</span><span class="mi">8</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">base_lr</span> <span class="o">=</span> <span class="n">base_lr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_lr</span> <span class="o">=</span> <span class="n">max_lr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stepsize</span> <span class="o">=</span> <span class="n">stepsize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iterations</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="p">{}</span>
        
    <span class="k">def</span> <span class="nf">clr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cycle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="mi">1</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">iterations</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">stepsize</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iterations</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">stepsize</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">cycle</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_lr</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_lr</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_lr</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="o">-</span><span class="n">x</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">**</span><span class="p">(</span><span class="n">cycle</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
    
    <span class="k">def</span> <span class="nf">on_train_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">logs</span><span class="o">=</span><span class="p">{}):</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">lr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_lr</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">on_batch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">batch</span><span class="p">,</span><span class="n">logs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">logs</span> <span class="o">=</span> <span class="n">logs</span> <span class="ow">or</span> <span class="p">{}</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">iterations</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;lr&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">lr</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;iterations&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iterations</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">logs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        
        <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">lr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">clr</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="training">
<h2>6. Training<a class="headerlink" href="#training" title="Permalink to this headline">¬∂</a></h2>
<div class="section" id="validation-scheme">
<h3>Validation Scheme<a class="headerlink" href="#validation-scheme" title="Permalink to this headline">¬∂</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">stratified_group_k_fold</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;https://www.kaggle.com/jakubwasikowski/stratified-group-k-fold-cross-validation&quot;&quot;&quot;</span>
    
    <span class="n">labels_num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>
    <span class="n">y_counts_per_group</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">labels_num</span><span class="p">))</span>
    <span class="n">y_distr</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">groups</span><span class="p">):</span>
        <span class="n">y_counts_per_group</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="n">label</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">y_distr</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">y_counts_per_fold</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">labels_num</span><span class="p">))</span>
    <span class="n">groups_per_fold</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">eval_y_counts_per_fold</span><span class="p">(</span><span class="n">y_counts</span><span class="p">,</span> <span class="n">fold</span><span class="p">):</span>
        <span class="n">y_counts_per_fold</span><span class="p">[</span><span class="n">fold</span><span class="p">]</span> <span class="o">+=</span> <span class="n">y_counts</span>
        <span class="n">std_per_label</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">labels_num</span><span class="p">):</span>
            <span class="n">label_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">([</span><span class="n">y_counts_per_fold</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">label</span><span class="p">]</span> <span class="o">/</span> <span class="n">y_distr</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)])</span>
            <span class="n">std_per_label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label_std</span><span class="p">)</span>
        <span class="n">y_counts_per_fold</span><span class="p">[</span><span class="n">fold</span><span class="p">]</span> <span class="o">-=</span> <span class="n">y_counts</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">std_per_label</span><span class="p">)</span>
    
    <span class="n">groups_and_y_counts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">y_counts_per_group</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
    <span class="n">random</span><span class="o">.</span><span class="n">Random</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">groups_and_y_counts</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">g</span><span class="p">,</span> <span class="n">y_counts</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">groups_and_y_counts</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
        <span class="n">best_fold</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">min_eval</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
            <span class="n">fold_eval</span> <span class="o">=</span> <span class="n">eval_y_counts_per_fold</span><span class="p">(</span><span class="n">y_counts</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">min_eval</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">fold_eval</span> <span class="o">&lt;</span> <span class="n">min_eval</span><span class="p">:</span>
                <span class="n">min_eval</span> <span class="o">=</span> <span class="n">fold_eval</span>
                <span class="n">best_fold</span> <span class="o">=</span> <span class="n">i</span>
        <span class="n">y_counts_per_fold</span><span class="p">[</span><span class="n">best_fold</span><span class="p">]</span> <span class="o">+=</span> <span class="n">y_counts</span>
        <span class="n">groups_per_fold</span><span class="p">[</span><span class="n">best_fold</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>

    <span class="n">all_groups</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
        <span class="n">train_groups</span> <span class="o">=</span> <span class="n">all_groups</span> <span class="o">-</span> <span class="n">groups_per_fold</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">test_groups</span> <span class="o">=</span> <span class="n">groups_per_fold</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="n">train_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span> <span class="k">if</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">train_groups</span><span class="p">]</span>
        <span class="n">test_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span> <span class="k">if</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">test_groups</span><span class="p">]</span>

        <span class="k">yield</span> <span class="n">train_indices</span><span class="p">,</span> <span class="n">test_indices</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">list_physical_devices</span><span class="p">(</span><span class="s1">&#39;GPU&#39;</span><span class="p">)):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Training on GPU&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Not on GPU&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Training on GPU
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>

<span class="n">histories</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">private_preds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">private_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">130</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">public_preds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">public_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">107</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="n">oof_pred</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">oof_tar</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">oof_val</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">oof_ids</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">skf</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">FOLDS</span><span class="p">,</span> <span class="n">random_state</span> <span class="o">=</span> <span class="n">SEED</span><span class="p">)</span>

<span class="n">skf_y</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="s1">&#39;SN_filter&#39;</span><span class="p">]</span>
<span class="k">if</span> <span class="n">SKF_SNR</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;#### Stratified on SNRs&quot;</span><span class="p">)</span>
    <span class="n">skf_y</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="s1">&#39;snr_stratify_group&#39;</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;unique SNR Groups: &quot;</span><span class="p">,</span><span class="n">skf_y</span><span class="o">.</span><span class="n">nunique</span><span class="p">())</span>
    
<span class="n">splits</span> <span class="o">=</span> <span class="n">skf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">skf_y</span><span class="p">)</span>
<span class="k">if</span> <span class="n">AUGMENTED</span><span class="p">:</span>
    <span class="c1"># splits = GroupKFold(FOLDS).split(train,groups=skf_y)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;#### Grouped by train.ids&quot;</span><span class="p">)</span>
    <span class="n">splits</span> <span class="o">=</span> <span class="n">stratified_group_k_fold</span><span class="p">(</span><span class="n">train</span><span class="p">,</span><span class="n">skf_y</span><span class="p">,</span><span class="n">train</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="n">FOLDS</span><span class="p">,</span><span class="n">seed</span><span class="o">=</span><span class="n">SEED</span><span class="p">)</span>

<span class="k">for</span> <span class="n">fold</span><span class="p">,</span> <span class="p">(</span><span class="n">idxT</span><span class="p">,</span> <span class="n">idxV</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">splits</span><span class="p">):</span>
    
    <span class="nb">print</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;#### FOLD: &quot;</span><span class="p">,</span><span class="n">fold</span><span class="p">)</span>

    <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">idxT</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">idxT</span><span class="p">]</span>
    <span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">idxV</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">idxV</span><span class="p">]</span>
    
    <span class="c1"># Filters of Validation Data</span>
    <span class="n">filter_</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idxV</span><span class="p">]</span><span class="o">.</span><span class="n">SN_filter</span><span class="o">==</span><span class="mi">1</span>
    <span class="k">if</span> <span class="n">AUGMENTED</span><span class="p">:</span>
        <span class="n">filter_</span> <span class="o">=</span> <span class="p">(</span><span class="n">train</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idxV</span><span class="p">]</span><span class="o">.</span><span class="n">SN_filter</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">train</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idxV</span><span class="p">]</span><span class="o">.</span><span class="n">cnt</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span> <span class="o">=</span> <span class="n">X_val</span><span class="p">[</span><span class="n">filter_</span><span class="p">],</span> <span class="n">y_val</span><span class="p">[</span><span class="n">filter_</span><span class="p">]</span>
    
    <span class="n">oof_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idxV</span><span class="p">][</span><span class="n">filter_</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">oof_tar</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">idxV</span><span class="p">][</span><span class="n">filter_</span><span class="p">])</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;#### Train Shape: &quot;</span><span class="p">,</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;#### Validation Shape: &quot;</span><span class="p">,</span><span class="n">X_val</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    
<span class="c1">#     continue</span>

<span class="c1">#     snr = train.iloc[idxT][&#39;signal_to_noise&#39;].values</span>
<span class="c1">#     weights = np.abs(snr)</span>
<span class="c1">#     weights[weights&gt;1], weights[weights&lt;1] = 1, 2</span>
    
    <span class="n">modelCheckpoint</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">ModelCheckpoint</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;WEIGHTS_FOLD</span><span class="si">{fold}</span><span class="s1">.h5&#39;</span><span class="p">,</span><span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;val_loss&#39;</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;min&#39;</span><span class="p">)</span>
    <span class="n">csvLogger</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">CSVLogger</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;TRAININGLOGS_FOLD</span><span class="si">{fold}</span><span class="s1">.csv&#39;</span><span class="p">)</span>
    
    <span class="c1"># LR SCHEDULE</span>
    <span class="n">lr_schedule</span> <span class="o">=</span> <span class="n">get_cosine_schedule_with_warmup</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="n">LR</span><span class="p">,</span><span class="n">num_warmup_steps</span><span class="o">=</span><span class="n">WARMUP</span><span class="p">,</span><span class="n">num_training_steps</span><span class="o">=</span><span class="n">EPOCHS</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">CYCLIC_LRS</span><span class="p">:</span>
        <span class="n">lr_schedule</span> <span class="o">=</span> <span class="n">CyclicLR</span><span class="p">(</span><span class="n">base_lr</span><span class="o">=</span><span class="n">CYCLIC_BLR</span><span class="p">,</span><span class="n">max_lr</span><span class="o">=</span><span class="n">CYCLIC_MLR</span><span class="p">,</span><span class="n">stepsize</span><span class="o">=</span><span class="n">CYCLIC_STEP</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">EXPDECAY_LRS</span><span class="p">:</span>
        <span class="n">lrfn</span> <span class="o">=</span> <span class="n">build_lrfn</span><span class="p">()</span>
        <span class="n">lr_schedule</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">LearningRateScheduler</span><span class="p">(</span><span class="n">lrfn</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">TRANSFORMERS</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">build_model</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">build_transformer</span><span class="p">()</span>
    
    <span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">AUGMENTED</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;#### Training on Augmented Data: &quot;</span><span class="p">)</span>
        <span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">getTrainGenerator</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span><span class="n">y_train</span><span class="p">),</span> 
                        <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_val</span><span class="p">,</span><span class="n">y_val</span><span class="p">),</span>
                        <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span>
                        <span class="n">epochs</span><span class="o">=</span><span class="n">EPOCHS</span><span class="p">,</span>
<span class="c1">#                         sample_weight = weights,</span>
                        <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">lr_schedule</span><span class="p">,</span><span class="n">modelCheckpoint</span><span class="p">,</span><span class="n">csvLogger</span><span class="p">],</span>
                        <span class="n">verbose</span> <span class="o">=</span> <span class="n">VERBOSE</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> 
                            <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_val</span><span class="p">,</span><span class="n">y_val</span><span class="p">),</span>
                            <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span>
                            <span class="n">epochs</span><span class="o">=</span><span class="n">EPOCHS</span><span class="p">,</span>
<span class="c1">#                             sample_weight = weights,</span>
                            <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">lr_schedule</span><span class="p">,</span><span class="n">modelCheckpoint</span><span class="p">,</span><span class="n">csvLogger</span><span class="p">],</span>
                            <span class="n">verbose</span> <span class="o">=</span> <span class="n">VERBOSE</span><span class="p">)</span>

    <span class="n">histories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">history</span><span class="p">)</span>
    
    <span class="n">model</span><span class="o">.</span><span class="n">load_weights</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;WEIGHTS_FOLD</span><span class="si">{fold}</span><span class="s1">.h5&#39;</span><span class="p">)</span>
    
    <span class="c1"># VAL PREDICTIONS</span>
    <span class="n">val_preds</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_val</span><span class="p">)</span>
    <span class="n">oof_val</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">]))</span>
    
    <span class="n">oof_pred</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val_preds</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">INFER_TEST</span><span class="p">:</span>

        <span class="c1">#load best model and predict</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">TRANSFORMERS</span><span class="p">:</span>
            <span class="n">public_model</span> <span class="o">=</span> <span class="n">build_model</span><span class="p">(</span><span class="n">seq_len</span><span class="o">=</span><span class="mi">107</span><span class="p">,</span> <span class="n">pred_len</span><span class="o">=</span><span class="mi">107</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">public_model</span> <span class="o">=</span> <span class="n">build_transformer</span><span class="p">(</span><span class="n">seq_len</span><span class="o">=</span><span class="mi">107</span><span class="p">,</span> <span class="n">pred_len</span><span class="o">=</span><span class="mi">107</span><span class="p">)</span>
            
        <span class="n">public_model</span><span class="o">.</span><span class="n">load_weights</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;WEIGHTS_FOLD</span><span class="si">{fold}</span><span class="s1">.h5&#39;</span><span class="p">)</span>
        <span class="n">public_pred</span> <span class="o">=</span> <span class="n">public_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_public</span><span class="p">)</span> <span class="o">/</span> <span class="n">FOLDS</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">TRANSFORMERS</span><span class="p">:</span>
            <span class="n">private_model</span> <span class="o">=</span> <span class="n">build_model</span><span class="p">(</span><span class="n">seq_len</span><span class="o">=</span><span class="mi">130</span><span class="p">,</span> <span class="n">pred_len</span><span class="o">=</span><span class="mi">130</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">private_model</span> <span class="o">=</span> <span class="n">build_transformer</span><span class="p">(</span><span class="n">seq_len</span><span class="o">=</span><span class="mi">130</span><span class="p">,</span> <span class="n">pred_len</span><span class="o">=</span><span class="mi">130</span><span class="p">)</span>
        
        <span class="n">private_model</span><span class="o">.</span><span class="n">load_weights</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;WEIGHTS_FOLD</span><span class="si">{fold}</span><span class="s1">.h5&#39;</span><span class="p">)</span>
        <span class="n">private_pred</span> <span class="o">=</span> <span class="n">private_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_private</span><span class="p">)</span> <span class="o">/</span> <span class="n">FOLDS</span>

        <span class="n">public_preds</span> <span class="o">+=</span> <span class="n">public_pred</span>
        <span class="n">private_preds</span> <span class="o">+=</span> <span class="n">private_pred</span>

        <span class="k">del</span> <span class="n">public_model</span><span class="p">,</span> <span class="n">private_model</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
    
    <span class="c1"># PLOT TRAINING</span>
    <span class="k">if</span> <span class="n">DISPLAY_PLOT</span><span class="p">:</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">EPOCHS</span><span class="p">),</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">],</span><span class="s1">&#39;-o&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Train Loss&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;#cc0044&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">EPOCHS</span><span class="p">),</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">],</span><span class="s1">&#39;-o&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Val Loss&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;#6600ff&#39;</span><span class="p">)</span>
        
        <span class="n">x_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span> <span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">]</span> <span class="p">);</span> <span class="n">y_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span> <span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">]</span> <span class="p">)</span>
        
        <span class="n">xdist</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">()[</span><span class="mi">0</span><span class="p">];</span> <span class="n">ydist</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_</span><span class="p">,</span><span class="n">y_</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;#6600ff&#39;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x_</span><span class="o">-</span><span class="mf">0.03</span><span class="o">*</span><span class="n">xdist</span><span class="p">,</span><span class="n">y_</span><span class="o">+</span><span class="mf">0.05</span><span class="o">*</span><span class="n">ydist</span><span class="p">,</span><span class="n">f</span><span class="s1">&#39;min loss - </span><span class="si">{y_}</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;RMSE Loss&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;FOLD - </span><span class="si">{fold}</span><span class="s1"> Training Losses &amp; Validation Losses&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        
    <span class="k">del</span> <span class="n">model</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>#### Stratified on SNRs
unique SNR Groups:  10
#### Grouped by train.ids

##################################################
#### FOLD:  0
#### Train Shape:  (3153, 107, 11)
#### Validation Shape:  (318, 107, 11)
Model: &quot;functional_3&quot;
__________________________________________________________________________________________________
Layer (type)                    Output Shape         Param #     Connected to                     
==================================================================================================
input_2 (InputLayer)            [(None, 107, 11)]    0                                            
__________________________________________________________________________________________________
tf_op_layer_strided_slice_3 (Te [(None, 107, 4)]     0           input_2[0][0]                    
__________________________________________________________________________________________________
embedding_1 (Embedding)         (None, 107, 4, 100)  1500        tf_op_layer_strided_slice_3[0][0]
__________________________________________________________________________________________________
tf_op_layer_Reshape_1 (TensorFl [(None, 107, 400)]   0           embedding_1[0][0]                
__________________________________________________________________________________________________
spatial_dropout1d_1 (SpatialDro (None, 107, 400)     0           tf_op_layer_Reshape_1[0][0]      
__________________________________________________________________________________________________
tf_op_layer_strided_slice_4 (Te [(None, 107, 7)]     0           input_2[0][0]                    
__________________________________________________________________________________________________
concatenate_2 (Concatenate)     (None, 107, 407)     0           spatial_dropout1d_1[0][0]        
                                                                 tf_op_layer_strided_slice_4[0][0]
__________________________________________________________________________________________________
conv1d_1 (Conv1D)               (None, 107, 256)     312832      concatenate_2[0][0]              
__________________________________________________________________________________________________
bidirectional_3 (Bidirectional) (None, 107, 256)     296448      conv1d_1[0][0]                   
__________________________________________________________________________________________________
concatenate_3 (Concatenate)     (None, 107, 512)     0           bidirectional_3[0][0]            
                                                                 conv1d_1[0][0]                   
__________________________________________________________________________________________________
bidirectional_4 (Bidirectional) (None, 107, 256)     493056      concatenate_3[0][0]              
__________________________________________________________________________________________________
bidirectional_5 (Bidirectional) (None, 107, 256)     296448      bidirectional_4[0][0]            
__________________________________________________________________________________________________
tf_op_layer_strided_slice_5 (Te [(None, 68, 256)]    0           bidirectional_5[0][0]            
__________________________________________________________________________________________________
dense_1 (Dense)                 (None, 68, 5)        1285        tf_op_layer_strided_slice_5[0][0]
==================================================================================================
Total params: 1,401,569
Trainable params: 1,401,569
Non-trainable params: 0
__________________________________________________________________________________________________


#### Training on Augmented Data: 
Epoch 1/100
99/99 - 6s - loss: 0.5326 - val_loss: 0.3406
Epoch 2/100
99/99 - 4s - loss: 0.4487 - val_loss: 0.3149
Epoch 3/100
99/99 - 4s - loss: 0.4300 - val_loss: 0.2978
Epoch 4/100
99/99 - 4s - loss: 0.4173 - val_loss: 0.2873
Epoch 5/100
99/99 - 4s - loss: 0.4084 - val_loss: 0.2785
Epoch 6/100
99/99 - 4s - loss: 0.3998 - val_loss: 0.2653
Epoch 7/100
99/99 - 4s - loss: 0.3907 - val_loss: 0.2567
Epoch 8/100
99/99 - 4s - loss: 0.3834 - val_loss: 0.2483
Epoch 9/100
99/99 - 4s - loss: 0.3768 - val_loss: 0.2437
Epoch 10/100
99/99 - 4s - loss: 0.3700 - val_loss: 0.2404
Epoch 11/100
99/99 - 4s - loss: 0.3644 - val_loss: 0.2368
Epoch 12/100
99/99 - 4s - loss: 0.3594 - val_loss: 0.2365
Epoch 13/100
99/99 - 4s - loss: 0.3545 - val_loss: 0.2351
Epoch 14/100
99/99 - 4s - loss: 0.3498 - val_loss: 0.2310
Epoch 15/100
99/99 - 4s - loss: 0.3466 - val_loss: 0.2276
Epoch 16/100
99/99 - 4s - loss: 0.3431 - val_loss: 0.2238
Epoch 17/100
99/99 - 4s - loss: 0.3407 - val_loss: 0.2235
Epoch 18/100
99/99 - 4s - loss: 0.3385 - val_loss: 0.2222
Epoch 19/100
99/99 - 4s - loss: 0.3362 - val_loss: 0.2209
Epoch 20/100
99/99 - 5s - loss: 0.3328 - val_loss: 0.2213
Epoch 21/100
99/99 - 4s - loss: 0.3303 - val_loss: 0.2188
Epoch 22/100
99/99 - 4s - loss: 0.3286 - val_loss: 0.2178
Epoch 23/100
99/99 - 4s - loss: 0.3261 - val_loss: 0.2163
Epoch 24/100
99/99 - 4s - loss: 0.3247 - val_loss: 0.2172
Epoch 25/100
99/99 - 4s - loss: 0.3225 - val_loss: 0.2166
Epoch 26/100
99/99 - 4s - loss: 0.3226 - val_loss: 0.2187
Epoch 27/100
99/99 - 4s - loss: 0.3203 - val_loss: 0.2161
Epoch 28/100
99/99 - 4s - loss: 0.3192 - val_loss: 0.2153
Epoch 29/100
99/99 - 4s - loss: 0.3171 - val_loss: 0.2139
Epoch 30/100
99/99 - 4s - loss: 0.3159 - val_loss: 0.2130
Epoch 31/100
99/99 - 4s - loss: 0.3132 - val_loss: 0.2125
Epoch 32/100
99/99 - 4s - loss: 0.3118 - val_loss: 0.2135
Epoch 33/100
99/99 - 4s - loss: 0.3107 - val_loss: 0.2129
Epoch 34/100
99/99 - 4s - loss: 0.3101 - val_loss: 0.2131
Epoch 35/100
99/99 - 4s - loss: 0.3091 - val_loss: 0.2133
Epoch 36/100
99/99 - 4s - loss: 0.3075 - val_loss: 0.2122
Epoch 37/100
99/99 - 4s - loss: 0.3074 - val_loss: 0.2129
Epoch 38/100
99/99 - 4s - loss: 0.3058 - val_loss: 0.2139
Epoch 39/100
99/99 - 4s - loss: 0.3055 - val_loss: 0.2120
Epoch 40/100
99/99 - 4s - loss: 0.3040 - val_loss: 0.2124
Epoch 41/100
99/99 - 4s - loss: 0.3036 - val_loss: 0.2121
Epoch 42/100
99/99 - 4s - loss: 0.3025 - val_loss: 0.2123
Epoch 43/100
99/99 - 4s - loss: 0.3018 - val_loss: 0.2114
Epoch 44/100
99/99 - 4s - loss: 0.3007 - val_loss: 0.2104
Epoch 45/100
99/99 - 4s - loss: 0.3011 - val_loss: 0.2104
Epoch 46/100
99/99 - 4s - loss: 0.2995 - val_loss: 0.2125
Epoch 47/100
99/99 - 4s - loss: 0.2989 - val_loss: 0.2101
Epoch 48/100
99/99 - 4s - loss: 0.2988 - val_loss: 0.2117
Epoch 49/100
99/99 - 4s - loss: 0.2976 - val_loss: 0.2110
Epoch 50/100
99/99 - 4s - loss: 0.2971 - val_loss: 0.2114
Epoch 51/100
99/99 - 4s - loss: 0.2975 - val_loss: 0.2128
Epoch 52/100
99/99 - 4s - loss: 0.2960 - val_loss: 0.2110
Epoch 53/100
99/99 - 5s - loss: 0.2961 - val_loss: 0.2094
Epoch 54/100
99/99 - 4s - loss: 0.2972 - val_loss: 0.2123
Epoch 55/100
99/99 - 4s - loss: 0.2966 - val_loss: 0.2101
Epoch 56/100
99/99 - 4s - loss: 0.2947 - val_loss: 0.2109
Epoch 57/100
99/99 - 4s - loss: 0.2936 - val_loss: 0.2086
Epoch 58/100
99/99 - 4s - loss: 0.2931 - val_loss: 0.2094
Epoch 59/100
99/99 - 4s - loss: 0.2922 - val_loss: 0.2084
Epoch 60/100
99/99 - 4s - loss: 0.2915 - val_loss: 0.2088
Epoch 61/100
99/99 - 4s - loss: 0.2903 - val_loss: 0.2105
Epoch 62/100
99/99 - 4s - loss: 0.2899 - val_loss: 0.2099
Epoch 63/100
99/99 - 4s - loss: 0.2896 - val_loss: 0.2098
Epoch 64/100
99/99 - 4s - loss: 0.2890 - val_loss: 0.2087
Epoch 65/100
99/99 - 4s - loss: 0.2880 - val_loss: 0.2094
Epoch 66/100
99/99 - 4s - loss: 0.2884 - val_loss: 0.2095
Epoch 67/100
99/99 - 4s - loss: 0.2871 - val_loss: 0.2089
Epoch 68/100
99/99 - 4s - loss: 0.2871 - val_loss: 0.2095
Epoch 69/100
99/99 - 5s - loss: 0.2868 - val_loss: 0.2093
Epoch 70/100
99/99 - 4s - loss: 0.2863 - val_loss: 0.2088
Epoch 71/100
99/99 - 4s - loss: 0.2855 - val_loss: 0.2089
Epoch 72/100
99/99 - 4s - loss: 0.2848 - val_loss: 0.2097
Epoch 73/100
99/99 - 4s - loss: 0.2845 - val_loss: 0.2091
Epoch 74/100
99/99 - 4s - loss: 0.2848 - val_loss: 0.2087
Epoch 75/100
99/99 - 4s - loss: 0.2840 - val_loss: 0.2111
Epoch 76/100
99/99 - 4s - loss: 0.2837 - val_loss: 0.2091
Epoch 77/100
99/99 - 4s - loss: 0.2841 - val_loss: 0.2097
Epoch 78/100
99/99 - 4s - loss: 0.2836 - val_loss: 0.2106
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 79/100
99/99 - 4s - loss: 0.2829 - val_loss: 0.2088
Epoch 80/100
99/99 - 4s - loss: 0.2824 - val_loss: 0.2086
Epoch 81/100
99/99 - 4s - loss: 0.2830 - val_loss: 0.2083
Epoch 82/100
99/99 - 4s - loss: 0.2839 - val_loss: 0.2089
Epoch 83/100
99/99 - 4s - loss: 0.2833 - val_loss: 0.2088
Epoch 84/100
99/99 - 4s - loss: 0.2823 - val_loss: 0.2099
Epoch 85/100
99/99 - 4s - loss: 0.2811 - val_loss: 0.2087
Epoch 86/100
99/99 - 4s - loss: 0.2807 - val_loss: 0.2112
Epoch 87/100
99/99 - 4s - loss: 0.2804 - val_loss: 0.2090
Epoch 88/100
99/99 - 4s - loss: 0.2809 - val_loss: 0.2078
Epoch 89/100
99/99 - 4s - loss: 0.2793 - val_loss: 0.2072
Epoch 90/100
99/99 - 4s - loss: 0.2792 - val_loss: 0.2073
Epoch 91/100
99/99 - 4s - loss: 0.2800 - val_loss: 0.2075
Epoch 92/100
99/99 - 4s - loss: 0.2792 - val_loss: 0.2100
Epoch 93/100
99/99 - 4s - loss: 0.2783 - val_loss: 0.2098
Epoch 94/100
99/99 - 4s - loss: 0.2774 - val_loss: 0.2084
Epoch 95/100
99/99 - 4s - loss: 0.2780 - val_loss: 0.2085
Epoch 96/100
99/99 - 4s - loss: 0.2779 - val_loss: 0.2072
Epoch 97/100
99/99 - 4s - loss: 0.2772 - val_loss: 0.2080
Epoch 98/100
99/99 - 4s - loss: 0.2772 - val_loss: 0.2084
Epoch 99/100
99/99 - 4s - loss: 0.2773 - val_loss: 0.2100
Epoch 100/100
99/99 - 4s - loss: 0.2776 - val_loss: 0.2079
##################################################
</pre></div>
</div>
<img alt="../_images/openvaccine-transformers-lstm-gru_45_2.png" src="../_images/openvaccine-transformers-lstm-gru_45_2.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>##################################################
#### FOLD:  1
#### Train Shape:  (3157, 107, 11)
#### Validation Shape:  (318, 107, 11)
Model: &quot;functional_9&quot;
__________________________________________________________________________________________________
Layer (type)                    Output Shape         Param #     Connected to                     
==================================================================================================
input_5 (InputLayer)            [(None, 107, 11)]    0                                            
__________________________________________________________________________________________________
tf_op_layer_strided_slice_12 (T [(None, 107, 4)]     0           input_5[0][0]                    
__________________________________________________________________________________________________
embedding_4 (Embedding)         (None, 107, 4, 100)  1500        tf_op_layer_strided_slice_12[0][0
__________________________________________________________________________________________________
tf_op_layer_Reshape_4 (TensorFl [(None, 107, 400)]   0           embedding_4[0][0]                
__________________________________________________________________________________________________
spatial_dropout1d_4 (SpatialDro (None, 107, 400)     0           tf_op_layer_Reshape_4[0][0]      
__________________________________________________________________________________________________
tf_op_layer_strided_slice_13 (T [(None, 107, 7)]     0           input_5[0][0]                    
__________________________________________________________________________________________________
concatenate_8 (Concatenate)     (None, 107, 407)     0           spatial_dropout1d_4[0][0]        
                                                                 tf_op_layer_strided_slice_13[0][0
__________________________________________________________________________________________________
conv1d_4 (Conv1D)               (None, 107, 256)     312832      concatenate_8[0][0]              
__________________________________________________________________________________________________
bidirectional_12 (Bidirectional (None, 107, 256)     296448      conv1d_4[0][0]                   
__________________________________________________________________________________________________
concatenate_9 (Concatenate)     (None, 107, 512)     0           bidirectional_12[0][0]           
                                                                 conv1d_4[0][0]                   
__________________________________________________________________________________________________
bidirectional_13 (Bidirectional (None, 107, 256)     493056      concatenate_9[0][0]              
__________________________________________________________________________________________________
bidirectional_14 (Bidirectional (None, 107, 256)     296448      bidirectional_13[0][0]           
__________________________________________________________________________________________________
tf_op_layer_strided_slice_14 (T [(None, 68, 256)]    0           bidirectional_14[0][0]           
__________________________________________________________________________________________________
dense_4 (Dense)                 (None, 68, 5)        1285        tf_op_layer_strided_slice_14[0][0
==================================================================================================
Total params: 1,401,569
Trainable params: 1,401,569
Non-trainable params: 0
__________________________________________________________________________________________________


#### Training on Augmented Data: 
Epoch 1/100
99/99 - 6s - loss: 0.5339 - val_loss: 0.3404
Epoch 2/100
99/99 - 5s - loss: 0.4494 - val_loss: 0.3074
Epoch 3/100
99/99 - 4s - loss: 0.4288 - val_loss: 0.2948
Epoch 4/100
99/99 - 4s - loss: 0.4172 - val_loss: 0.2861
Epoch 5/100
99/99 - 4s - loss: 0.4087 - val_loss: 0.2731
Epoch 6/100
99/99 - 4s - loss: 0.3997 - val_loss: 0.2648
Epoch 7/100
99/99 - 4s - loss: 0.3920 - val_loss: 0.2540
Epoch 8/100
99/99 - 4s - loss: 0.3844 - val_loss: 0.2483
Epoch 9/100
99/99 - 4s - loss: 0.3777 - val_loss: 0.2428
Epoch 10/100
99/99 - 4s - loss: 0.3731 - val_loss: 0.2388
Epoch 11/100
99/99 - 4s - loss: 0.3660 - val_loss: 0.2359
Epoch 12/100
99/99 - 4s - loss: 0.3611 - val_loss: 0.2310
Epoch 13/100
99/99 - 4s - loss: 0.3559 - val_loss: 0.2295
Epoch 14/100
99/99 - 4s - loss: 0.3516 - val_loss: 0.2262
Epoch 15/100
99/99 - 5s - loss: 0.3479 - val_loss: 0.2224
Epoch 16/100
99/99 - 4s - loss: 0.3440 - val_loss: 0.2243
Epoch 17/100
99/99 - 4s - loss: 0.3412 - val_loss: 0.2231
Epoch 18/100
99/99 - 4s - loss: 0.3390 - val_loss: 0.2202
Epoch 19/100
99/99 - 4s - loss: 0.3357 - val_loss: 0.2184
Epoch 20/100
99/99 - 4s - loss: 0.3330 - val_loss: 0.2195
Epoch 21/100
99/99 - 4s - loss: 0.3307 - val_loss: 0.2163
Epoch 22/100
99/99 - 4s - loss: 0.3286 - val_loss: 0.2155
Epoch 23/100
99/99 - 4s - loss: 0.3262 - val_loss: 0.2145
Epoch 24/100
99/99 - 4s - loss: 0.3241 - val_loss: 0.2133
Epoch 25/100
99/99 - 4s - loss: 0.3218 - val_loss: 0.2128
Epoch 26/100
99/99 - 4s - loss: 0.3211 - val_loss: 0.2124
Epoch 27/100
99/99 - 4s - loss: 0.3203 - val_loss: 0.2139
Epoch 28/100
99/99 - 4s - loss: 0.3190 - val_loss: 0.2148
Epoch 29/100
99/99 - 4s - loss: 0.3187 - val_loss: 0.2143
Epoch 30/100
99/99 - 5s - loss: 0.3177 - val_loss: 0.2100
Epoch 31/100
99/99 - 4s - loss: 0.3152 - val_loss: 0.2102
Epoch 32/100
99/99 - 4s - loss: 0.3130 - val_loss: 0.2092
Epoch 33/100
99/99 - 4s - loss: 0.3122 - val_loss: 0.2093
Epoch 34/100
99/99 - 4s - loss: 0.3103 - val_loss: 0.2083
Epoch 35/100
99/99 - 4s - loss: 0.3086 - val_loss: 0.2076
Epoch 36/100
99/99 - 4s - loss: 0.3078 - val_loss: 0.2085
Epoch 37/100
99/99 - 4s - loss: 0.3071 - val_loss: 0.2080
Epoch 38/100
99/99 - 4s - loss: 0.3059 - val_loss: 0.2078
Epoch 39/100
99/99 - 4s - loss: 0.3056 - val_loss: 0.2072
Epoch 40/100
99/99 - 4s - loss: 0.3040 - val_loss: 0.2086
Epoch 41/100
99/99 - 4s - loss: 0.3024 - val_loss: 0.2077
Epoch 42/100
99/99 - 4s - loss: 0.3018 - val_loss: 0.2071
Epoch 43/100
99/99 - 4s - loss: 0.3008 - val_loss: 0.2061
Epoch 44/100
99/99 - 4s - loss: 0.2996 - val_loss: 0.2065
Epoch 45/100
99/99 - 4s - loss: 0.2991 - val_loss: 0.2052
Epoch 46/100
99/99 - 4s - loss: 0.2981 - val_loss: 0.2060
Epoch 47/100
99/99 - 4s - loss: 0.2975 - val_loss: 0.2069
Epoch 48/100
99/99 - 4s - loss: 0.2971 - val_loss: 0.2048
Epoch 49/100
99/99 - 4s - loss: 0.2965 - val_loss: 0.2043
Epoch 50/100
99/99 - 4s - loss: 0.2952 - val_loss: 0.2045
Epoch 51/100
99/99 - 4s - loss: 0.2950 - val_loss: 0.2035
Epoch 52/100
99/99 - 4s - loss: 0.2941 - val_loss: 0.2050
Epoch 53/100
99/99 - 4s - loss: 0.2941 - val_loss: 0.2034
Epoch 54/100
99/99 - 4s - loss: 0.2937 - val_loss: 0.2044
Epoch 55/100
99/99 - 4s - loss: 0.2933 - val_loss: 0.2048
Epoch 56/100
99/99 - 4s - loss: 0.2950 - val_loss: 0.2042
Epoch 57/100
99/99 - 4s - loss: 0.2923 - val_loss: 0.2066
Epoch 58/100
99/99 - 4s - loss: 0.2916 - val_loss: 0.2067
Epoch 59/100
99/99 - 5s - loss: 0.2915 - val_loss: 0.2054
Epoch 60/100
99/99 - 4s - loss: 0.2915 - val_loss: 0.2065
Epoch 61/100
99/99 - 4s - loss: 0.2917 - val_loss: 0.2050
Epoch 62/100
99/99 - 4s - loss: 0.2916 - val_loss: 0.2043
Epoch 63/100
99/99 - 4s - loss: 0.2912 - val_loss: 0.2042
Epoch 64/100
99/99 - 4s - loss: 0.2904 - val_loss: 0.2039
Epoch 65/100
99/99 - 4s - loss: 0.2898 - val_loss: 0.2034
Epoch 66/100
99/99 - 4s - loss: 0.2893 - val_loss: 0.2035
Epoch 67/100
99/99 - 4s - loss: 0.2890 - val_loss: 0.2027
Epoch 68/100
99/99 - 4s - loss: 0.2898 - val_loss: 0.2045
Epoch 69/100
99/99 - 4s - loss: 0.2899 - val_loss: 0.2050
Epoch 70/100
99/99 - 4s - loss: 0.2897 - val_loss: 0.2084
Epoch 71/100
99/99 - 4s - loss: 0.2887 - val_loss: 0.2082
Epoch 72/100
99/99 - 5s - loss: 0.2875 - val_loss: 0.2061
Epoch 73/100
99/99 - 5s - loss: 0.2858 - val_loss: 0.2052
Epoch 74/100
99/99 - 4s - loss: 0.2853 - val_loss: 0.2058
Epoch 75/100
99/99 - 4s - loss: 0.2844 - val_loss: 0.2037
Epoch 76/100
99/99 - 4s - loss: 0.2844 - val_loss: 0.2041
Epoch 77/100
99/99 - 4s - loss: 0.2849 - val_loss: 0.2032
Epoch 78/100
99/99 - 4s - loss: 0.2823 - val_loss: 0.2043
Epoch 79/100
99/99 - 4s - loss: 0.2822 - val_loss: 0.2036
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 80/100
99/99 - 4s - loss: 0.2828 - val_loss: 0.2046
Epoch 81/100
99/99 - 4s - loss: 0.2828 - val_loss: 0.2029
Epoch 82/100
99/99 - 4s - loss: 0.2815 - val_loss: 0.2042
Epoch 83/100
99/99 - 4s - loss: 0.2842 - val_loss: 0.2042
Epoch 84/100
99/99 - 4s - loss: 0.2818 - val_loss: 0.2034
Epoch 85/100
99/99 - 4s - loss: 0.2808 - val_loss: 0.2043
Epoch 86/100
99/99 - 5s - loss: 0.2793 - val_loss: 0.2034
Epoch 87/100
99/99 - 4s - loss: 0.2786 - val_loss: 0.2040
Epoch 88/100
99/99 - 4s - loss: 0.2782 - val_loss: 0.2030
Epoch 89/100
99/99 - 4s - loss: 0.2783 - val_loss: 0.2035
Epoch 90/100
99/99 - 4s - loss: 0.2784 - val_loss: 0.2032
Epoch 91/100
99/99 - 4s - loss: 0.2776 - val_loss: 0.2038
Epoch 92/100
99/99 - 4s - loss: 0.2776 - val_loss: 0.2038
Epoch 93/100
99/99 - 4s - loss: 0.2794 - val_loss: 0.2041
Epoch 94/100
99/99 - 4s - loss: 0.2777 - val_loss: 0.2040
Epoch 95/100
99/99 - 4s - loss: 0.2769 - val_loss: 0.2033
Epoch 96/100
99/99 - 4s - loss: 0.2763 - val_loss: 0.2039
Epoch 97/100
99/99 - 4s - loss: 0.2767 - val_loss: 0.2038
Epoch 98/100
99/99 - 4s - loss: 0.2768 - val_loss: 0.2044
Epoch 99/100
99/99 - 4s - loss: 0.2765 - val_loss: 0.2041
Epoch 100/100
99/99 - 4s - loss: 0.2821 - val_loss: 0.2038
##################################################
</pre></div>
</div>
<img alt="../_images/openvaccine-transformers-lstm-gru_45_5.png" src="../_images/openvaccine-transformers-lstm-gru_45_5.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>##################################################
#### FOLD:  2
#### Train Shape:  (3159, 107, 11)
#### Validation Shape:  (317, 107, 11)
Model: &quot;functional_15&quot;
__________________________________________________________________________________________________
Layer (type)                    Output Shape         Param #     Connected to                     
==================================================================================================
input_8 (InputLayer)            [(None, 107, 11)]    0                                            
__________________________________________________________________________________________________
tf_op_layer_strided_slice_21 (T [(None, 107, 4)]     0           input_8[0][0]                    
__________________________________________________________________________________________________
embedding_7 (Embedding)         (None, 107, 4, 100)  1500        tf_op_layer_strided_slice_21[0][0
__________________________________________________________________________________________________
tf_op_layer_Reshape_7 (TensorFl [(None, 107, 400)]   0           embedding_7[0][0]                
__________________________________________________________________________________________________
spatial_dropout1d_7 (SpatialDro (None, 107, 400)     0           tf_op_layer_Reshape_7[0][0]      
__________________________________________________________________________________________________
tf_op_layer_strided_slice_22 (T [(None, 107, 7)]     0           input_8[0][0]                    
__________________________________________________________________________________________________
concatenate_14 (Concatenate)    (None, 107, 407)     0           spatial_dropout1d_7[0][0]        
                                                                 tf_op_layer_strided_slice_22[0][0
__________________________________________________________________________________________________
conv1d_7 (Conv1D)               (None, 107, 256)     312832      concatenate_14[0][0]             
__________________________________________________________________________________________________
bidirectional_21 (Bidirectional (None, 107, 256)     296448      conv1d_7[0][0]                   
__________________________________________________________________________________________________
concatenate_15 (Concatenate)    (None, 107, 512)     0           bidirectional_21[0][0]           
                                                                 conv1d_7[0][0]                   
__________________________________________________________________________________________________
bidirectional_22 (Bidirectional (None, 107, 256)     493056      concatenate_15[0][0]             
__________________________________________________________________________________________________
bidirectional_23 (Bidirectional (None, 107, 256)     296448      bidirectional_22[0][0]           
__________________________________________________________________________________________________
tf_op_layer_strided_slice_23 (T [(None, 68, 256)]    0           bidirectional_23[0][0]           
__________________________________________________________________________________________________
dense_7 (Dense)                 (None, 68, 5)        1285        tf_op_layer_strided_slice_23[0][0
==================================================================================================
Total params: 1,401,569
Trainable params: 1,401,569
Non-trainable params: 0
__________________________________________________________________________________________________


#### Training on Augmented Data: 
Epoch 1/100
99/99 - 6s - loss: 0.5403 - val_loss: 0.3437
Epoch 2/100
99/99 - 4s - loss: 0.4562 - val_loss: 0.3072
Epoch 3/100
99/99 - 4s - loss: 0.4341 - val_loss: 0.2947
Epoch 4/100
99/99 - 4s - loss: 0.4221 - val_loss: 0.2839
Epoch 5/100
99/99 - 4s - loss: 0.4127 - val_loss: 0.2747
Epoch 6/100
99/99 - 4s - loss: 0.4042 - val_loss: 0.2643
Epoch 7/100
99/99 - 4s - loss: 0.3969 - val_loss: 0.2557
Epoch 8/100
99/99 - 5s - loss: 0.3891 - val_loss: 0.2486
Epoch 9/100
99/99 - 4s - loss: 0.3823 - val_loss: 0.2436
Epoch 10/100
99/99 - 4s - loss: 0.3769 - val_loss: 0.2407
Epoch 11/100
99/99 - 5s - loss: 0.3708 - val_loss: 0.2383
Epoch 12/100
99/99 - 4s - loss: 0.3656 - val_loss: 0.2338
Epoch 13/100
99/99 - 4s - loss: 0.3602 - val_loss: 0.2303
Epoch 14/100
99/99 - 4s - loss: 0.3562 - val_loss: 0.2295
Epoch 15/100
99/99 - 4s - loss: 0.3525 - val_loss: 0.2272
Epoch 16/100
99/99 - 4s - loss: 0.3496 - val_loss: 0.2260
Epoch 17/100
99/99 - 4s - loss: 0.3456 - val_loss: 0.2244
Epoch 18/100
99/99 - 4s - loss: 0.3433 - val_loss: 0.2245
Epoch 19/100
99/99 - 4s - loss: 0.3400 - val_loss: 0.2217
Epoch 20/100
99/99 - 4s - loss: 0.3374 - val_loss: 0.2204
Epoch 21/100
99/99 - 5s - loss: 0.3356 - val_loss: 0.2200
Epoch 22/100
99/99 - 4s - loss: 0.3339 - val_loss: 0.2186
Epoch 23/100
99/99 - 4s - loss: 0.3315 - val_loss: 0.2190
Epoch 24/100
99/99 - 4s - loss: 0.3289 - val_loss: 0.2167
Epoch 25/100
99/99 - 4s - loss: 0.3271 - val_loss: 0.2164
Epoch 26/100
99/99 - 5s - loss: 0.3249 - val_loss: 0.2166
Epoch 27/100
99/99 - 4s - loss: 0.3238 - val_loss: 0.2158
Epoch 28/100
99/99 - 4s - loss: 0.3226 - val_loss: 0.2149
Epoch 29/100
99/99 - 4s - loss: 0.3201 - val_loss: 0.2156
Epoch 30/100
99/99 - 4s - loss: 0.3183 - val_loss: 0.2140
Epoch 31/100
99/99 - 4s - loss: 0.3175 - val_loss: 0.2129
Epoch 32/100
99/99 - 4s - loss: 0.3162 - val_loss: 0.2150
Epoch 33/100
99/99 - 4s - loss: 0.3142 - val_loss: 0.2139
Epoch 34/100
99/99 - 4s - loss: 0.3145 - val_loss: 0.2133
Epoch 35/100
99/99 - 5s - loss: 0.3123 - val_loss: 0.2131
Epoch 36/100
99/99 - 4s - loss: 0.3135 - val_loss: 0.2138
Epoch 37/100
99/99 - 4s - loss: 0.3110 - val_loss: 0.2171
Epoch 38/100
99/99 - 4s - loss: 0.3102 - val_loss: 0.2150
Epoch 39/100
99/99 - 4s - loss: 0.3108 - val_loss: 0.2119
Epoch 40/100
99/99 - 4s - loss: 0.3085 - val_loss: 0.2103
Epoch 41/100
99/99 - 4s - loss: 0.3057 - val_loss: 0.2109
Epoch 42/100
99/99 - 4s - loss: 0.3056 - val_loss: 0.2131
Epoch 43/100
99/99 - 4s - loss: 0.3049 - val_loss: 0.2124
Epoch 44/100
99/99 - 4s - loss: 0.3039 - val_loss: 0.2113
Epoch 45/100
99/99 - 4s - loss: 0.3031 - val_loss: 0.2107
Epoch 46/100
99/99 - 4s - loss: 0.3021 - val_loss: 0.2096
Epoch 47/100
99/99 - 4s - loss: 0.3013 - val_loss: 0.2098
Epoch 48/100
99/99 - 5s - loss: 0.3002 - val_loss: 0.2096
Epoch 49/100
99/99 - 4s - loss: 0.2993 - val_loss: 0.2102
Epoch 50/100
99/99 - 4s - loss: 0.2997 - val_loss: 0.2099
Epoch 51/100
99/99 - 5s - loss: 0.2987 - val_loss: 0.2094
Epoch 52/100
99/99 - 4s - loss: 0.2983 - val_loss: 0.2096
Epoch 53/100
99/99 - 4s - loss: 0.2983 - val_loss: 0.2093
Epoch 54/100
99/99 - 4s - loss: 0.2969 - val_loss: 0.2090
Epoch 55/100
99/99 - 4s - loss: 0.2975 - val_loss: 0.2094
Epoch 56/100
99/99 - 4s - loss: 0.2967 - val_loss: 0.2091
Epoch 57/100
99/99 - 4s - loss: 0.2964 - val_loss: 0.2094
Epoch 58/100
99/99 - 4s - loss: 0.2973 - val_loss: 0.2103
Epoch 59/100
99/99 - 4s - loss: 0.2965 - val_loss: 0.2091
Epoch 60/100
99/99 - 4s - loss: 0.2964 - val_loss: 0.2089
Epoch 61/100
99/99 - 5s - loss: 0.2955 - val_loss: 0.2110
Epoch 62/100
99/99 - 4s - loss: 0.2938 - val_loss: 0.2083
Epoch 63/100
99/99 - 4s - loss: 0.2927 - val_loss: 0.2084
Epoch 64/100
99/99 - 4s - loss: 0.2921 - val_loss: 0.2082
Epoch 65/100
99/99 - 4s - loss: 0.2915 - val_loss: 0.2083
Epoch 66/100
99/99 - 4s - loss: 0.2906 - val_loss: 0.2085
Epoch 67/100
99/99 - 4s - loss: 0.2896 - val_loss: 0.2071
Epoch 68/100
99/99 - 5s - loss: 0.2889 - val_loss: 0.2077
Epoch 69/100
99/99 - 4s - loss: 0.2888 - val_loss: 0.2089
Epoch 70/100
99/99 - 4s - loss: 0.2884 - val_loss: 0.2088
Epoch 71/100
99/99 - 4s - loss: 0.2884 - val_loss: 0.2083
Epoch 72/100
99/99 - 4s - loss: 0.2897 - val_loss: 0.2082
Epoch 73/100
99/99 - 4s - loss: 0.2870 - val_loss: 0.2070
Epoch 74/100
99/99 - 4s - loss: 0.2861 - val_loss: 0.2077
Epoch 75/100
99/99 - 4s - loss: 0.2857 - val_loss: 0.2079
Epoch 76/100
99/99 - 5s - loss: 0.2852 - val_loss: 0.2071
Epoch 77/100
99/99 - 4s - loss: 0.2858 - val_loss: 0.2070
Epoch 78/100
99/99 - 5s - loss: 0.2849 - val_loss: 0.2081
Epoch 79/100
99/99 - 4s - loss: 0.2851 - val_loss: 0.2083
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 80/100
99/99 - 4s - loss: 0.2856 - val_loss: 0.2065
Epoch 81/100
99/99 - 4s - loss: 0.2841 - val_loss: 0.2074
Epoch 82/100
99/99 - 4s - loss: 0.2835 - val_loss: 0.2068
Epoch 83/100
99/99 - 4s - loss: 0.2859 - val_loss: 0.2079
Epoch 84/100
99/99 - 4s - loss: 0.2846 - val_loss: 0.2059
Epoch 85/100
99/99 - 4s - loss: 0.2832 - val_loss: 0.2071
Epoch 86/100
99/99 - 4s - loss: 0.2822 - val_loss: 0.2070
Epoch 87/100
99/99 - 4s - loss: 0.2818 - val_loss: 0.2077
Epoch 88/100
99/99 - 4s - loss: 0.2810 - val_loss: 0.2070
Epoch 89/100
99/99 - 5s - loss: 0.2808 - val_loss: 0.2055
Epoch 90/100
99/99 - 4s - loss: 0.2804 - val_loss: 0.2058
Epoch 91/100
99/99 - 5s - loss: 0.2801 - val_loss: 0.2061
Epoch 92/100
99/99 - 4s - loss: 0.2810 - val_loss: 0.2081
Epoch 93/100
99/99 - 4s - loss: 0.2843 - val_loss: 0.2071
Epoch 94/100
99/99 - 4s - loss: 0.2838 - val_loss: 0.2084
Epoch 95/100
99/99 - 4s - loss: 0.2817 - val_loss: 0.2073
Epoch 96/100
99/99 - 4s - loss: 0.2801 - val_loss: 0.2074
Epoch 97/100
99/99 - 4s - loss: 0.2811 - val_loss: 0.2073
Epoch 98/100
99/99 - 4s - loss: 0.2813 - val_loss: 0.2067
Epoch 99/100
99/99 - 4s - loss: 0.2821 - val_loss: 0.2075
Epoch 100/100
99/99 - 4s - loss: 0.2802 - val_loss: 0.2089
##################################################
</pre></div>
</div>
<img alt="../_images/openvaccine-transformers-lstm-gru_45_8.png" src="../_images/openvaccine-transformers-lstm-gru_45_8.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>##################################################
#### FOLD:  3
#### Train Shape:  (3160, 107, 11)
#### Validation Shape:  (318, 107, 11)
Model: &quot;functional_21&quot;
__________________________________________________________________________________________________
Layer (type)                    Output Shape         Param #     Connected to                     
==================================================================================================
input_11 (InputLayer)           [(None, 107, 11)]    0                                            
__________________________________________________________________________________________________
tf_op_layer_strided_slice_30 (T [(None, 107, 4)]     0           input_11[0][0]                   
__________________________________________________________________________________________________
embedding_10 (Embedding)        (None, 107, 4, 100)  1500        tf_op_layer_strided_slice_30[0][0
__________________________________________________________________________________________________
tf_op_layer_Reshape_10 (TensorF [(None, 107, 400)]   0           embedding_10[0][0]               
__________________________________________________________________________________________________
spatial_dropout1d_10 (SpatialDr (None, 107, 400)     0           tf_op_layer_Reshape_10[0][0]     
__________________________________________________________________________________________________
tf_op_layer_strided_slice_31 (T [(None, 107, 7)]     0           input_11[0][0]                   
__________________________________________________________________________________________________
concatenate_20 (Concatenate)    (None, 107, 407)     0           spatial_dropout1d_10[0][0]       
                                                                 tf_op_layer_strided_slice_31[0][0
__________________________________________________________________________________________________
conv1d_10 (Conv1D)              (None, 107, 256)     312832      concatenate_20[0][0]             
__________________________________________________________________________________________________
bidirectional_30 (Bidirectional (None, 107, 256)     296448      conv1d_10[0][0]                  
__________________________________________________________________________________________________
concatenate_21 (Concatenate)    (None, 107, 512)     0           bidirectional_30[0][0]           
                                                                 conv1d_10[0][0]                  
__________________________________________________________________________________________________
bidirectional_31 (Bidirectional (None, 107, 256)     493056      concatenate_21[0][0]             
__________________________________________________________________________________________________
bidirectional_32 (Bidirectional (None, 107, 256)     296448      bidirectional_31[0][0]           
__________________________________________________________________________________________________
tf_op_layer_strided_slice_32 (T [(None, 68, 256)]    0           bidirectional_32[0][0]           
__________________________________________________________________________________________________
dense_10 (Dense)                (None, 68, 5)        1285        tf_op_layer_strided_slice_32[0][0
==================================================================================================
Total params: 1,401,569
Trainable params: 1,401,569
Non-trainable params: 0
__________________________________________________________________________________________________


#### Training on Augmented Data: 
Epoch 1/100
99/99 - 6s - loss: 1.1768 - val_loss: 0.3621
Epoch 2/100
99/99 - 5s - loss: 1.1439 - val_loss: 0.3196
Epoch 3/100
99/99 - 4s - loss: 1.1357 - val_loss: 0.3093
Epoch 4/100
99/99 - 4s - loss: 1.1318 - val_loss: 0.3044
Epoch 5/100
99/99 - 5s - loss: 1.1288 - val_loss: 0.2931
Epoch 6/100
99/99 - 4s - loss: 1.1265 - val_loss: 0.2876
Epoch 7/100
99/99 - 5s - loss: 1.1245 - val_loss: 0.2808
Epoch 8/100
99/99 - 4s - loss: 1.1227 - val_loss: 0.2748
Epoch 9/100
99/99 - 4s - loss: 1.1210 - val_loss: 0.2693
Epoch 10/100
99/99 - 5s - loss: 1.1200 - val_loss: 0.2662
Epoch 11/100
99/99 - 4s - loss: 1.1187 - val_loss: 0.2647
Epoch 12/100
99/99 - 5s - loss: 1.1168 - val_loss: 0.2626
Epoch 13/100
99/99 - 4s - loss: 1.1151 - val_loss: 0.2567
Epoch 14/100
99/99 - 4s - loss: 1.1143 - val_loss: 0.2568
Epoch 15/100
99/99 - 4s - loss: 1.1132 - val_loss: 0.2553
Epoch 16/100
99/99 - 4s - loss: 1.1121 - val_loss: 0.2534
Epoch 17/100
99/99 - 4s - loss: 1.1110 - val_loss: 0.2505
Epoch 18/100
99/99 - 4s - loss: 1.1097 - val_loss: 0.2485
Epoch 19/100
99/99 - 4s - loss: 1.1090 - val_loss: 0.2483
Epoch 20/100
99/99 - 4s - loss: 1.1079 - val_loss: 0.2475
Epoch 21/100
99/99 - 4s - loss: 1.1069 - val_loss: 0.2495
Epoch 22/100
99/99 - 4s - loss: 1.1066 - val_loss: 0.2475
Epoch 23/100
99/99 - 4s - loss: 1.1060 - val_loss: 0.2477
Epoch 24/100
99/99 - 5s - loss: 1.1050 - val_loss: 0.2447
Epoch 25/100
99/99 - 4s - loss: 1.1035 - val_loss: 0.2478
Epoch 26/100
99/99 - 4s - loss: 1.1029 - val_loss: 0.2454
Epoch 27/100
99/99 - 4s - loss: 1.1033 - val_loss: 0.2458
Epoch 28/100
99/99 - 4s - loss: 1.1022 - val_loss: 0.2473
Epoch 29/100
99/99 - 4s - loss: 1.1014 - val_loss: 0.2441
Epoch 30/100
99/99 - 4s - loss: 1.1012 - val_loss: 0.2463
Epoch 31/100
99/99 - 4s - loss: 1.1006 - val_loss: 0.2442
Epoch 32/100
99/99 - 4s - loss: 1.1000 - val_loss: 0.2427
Epoch 33/100
99/99 - 4s - loss: 1.0994 - val_loss: 0.2421
Epoch 34/100
99/99 - 4s - loss: 1.0991 - val_loss: 0.2437
Epoch 35/100
99/99 - 4s - loss: 1.0983 - val_loss: 0.2430
Epoch 36/100
99/99 - 4s - loss: 1.0982 - val_loss: 0.2427
Epoch 37/100
99/99 - 5s - loss: 1.0973 - val_loss: 0.2434
Epoch 38/100
99/99 - 4s - loss: 1.0970 - val_loss: 0.2412
Epoch 39/100
99/99 - 4s - loss: 1.0968 - val_loss: 0.2423
Epoch 40/100
99/99 - 4s - loss: 1.0969 - val_loss: 0.2420
Epoch 41/100
99/99 - 4s - loss: 1.0963 - val_loss: 0.2444
Epoch 42/100
99/99 - 4s - loss: 1.0958 - val_loss: 0.2414
Epoch 43/100
99/99 - 4s - loss: 1.0952 - val_loss: 0.2436
Epoch 44/100
99/99 - 4s - loss: 1.0950 - val_loss: 0.2425
Epoch 45/100
99/99 - 4s - loss: 1.0948 - val_loss: 0.2414
Epoch 46/100
99/99 - 4s - loss: 1.0940 - val_loss: 0.2440
Epoch 47/100
99/99 - 5s - loss: 1.0943 - val_loss: 0.2416
Epoch 48/100
99/99 - 4s - loss: 1.0930 - val_loss: 0.2455
Epoch 49/100
99/99 - 4s - loss: 1.0936 - val_loss: 0.2448
Epoch 50/100
99/99 - 4s - loss: 1.0926 - val_loss: 0.2412
Epoch 51/100
99/99 - 4s - loss: 1.0922 - val_loss: 0.2421
Epoch 52/100
99/99 - 5s - loss: 1.0915 - val_loss: 0.2440
Epoch 53/100
99/99 - 4s - loss: 1.0922 - val_loss: 0.2413
Epoch 54/100
99/99 - 4s - loss: 1.0911 - val_loss: 0.2443
Epoch 55/100
99/99 - 4s - loss: 1.0916 - val_loss: 0.2434
Epoch 56/100
99/99 - 4s - loss: 1.0911 - val_loss: 0.2445
Epoch 57/100
99/99 - 4s - loss: 1.0914 - val_loss: 0.2413
Epoch 58/100
99/99 - 4s - loss: 1.0904 - val_loss: 0.2441
Epoch 59/100
99/99 - 4s - loss: 1.0901 - val_loss: 0.2428
Epoch 60/100
99/99 - 4s - loss: 1.0890 - val_loss: 0.2462
Epoch 61/100
99/99 - 4s - loss: 1.0886 - val_loss: 0.2462
Epoch 62/100
99/99 - 5s - loss: 1.0883 - val_loss: 0.2428
Epoch 63/100
99/99 - 4s - loss: 1.0878 - val_loss: 0.2424
Epoch 64/100
99/99 - 5s - loss: 1.0883 - val_loss: 0.2455
Epoch 65/100
99/99 - 4s - loss: 1.0894 - val_loss: 0.2453
Epoch 66/100
99/99 - 4s - loss: 1.0893 - val_loss: 0.2450
Epoch 67/100
99/99 - 4s - loss: 1.0889 - val_loss: 0.2444
Epoch 68/100
99/99 - 4s - loss: 1.0882 - val_loss: 0.2464
Epoch 69/100
99/99 - 4s - loss: 1.0908 - val_loss: 0.2456
Epoch 70/100
99/99 - 4s - loss: 1.0882 - val_loss: 0.2465
Epoch 71/100
99/99 - 4s - loss: 1.0878 - val_loss: 0.2453
Epoch 72/100
99/99 - 4s - loss: 1.0871 - val_loss: 0.2444
Epoch 73/100
99/99 - 4s - loss: 1.0866 - val_loss: 0.2444
Epoch 74/100
99/99 - 4s - loss: 1.0857 - val_loss: 0.2439
Epoch 75/100
99/99 - 4s - loss: 1.0868 - val_loss: 0.2418
Epoch 76/100
99/99 - 4s - loss: 1.0849 - val_loss: 0.2461
Epoch 77/100
99/99 - 4s - loss: 1.0847 - val_loss: 0.2481
Epoch 78/100
99/99 - 4s - loss: 1.0861 - val_loss: 0.2500
Epoch 79/100
99/99 - 5s - loss: 1.0867 - val_loss: 0.2484
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 80/100
99/99 - 4s - loss: 1.0858 - val_loss: 0.2421
Epoch 81/100
99/99 - 4s - loss: 1.0854 - val_loss: 0.2468
Epoch 82/100
99/99 - 4s - loss: 1.0870 - val_loss: 0.2458
Epoch 83/100
99/99 - 4s - loss: 1.0894 - val_loss: 0.2450
Epoch 84/100
99/99 - 4s - loss: 1.0890 - val_loss: 0.2455
Epoch 85/100
99/99 - 4s - loss: 1.0871 - val_loss: 0.2442
Epoch 86/100
99/99 - 4s - loss: 1.0857 - val_loss: 0.2460
Epoch 87/100
99/99 - 4s - loss: 1.0842 - val_loss: 0.2433
Epoch 88/100
99/99 - 4s - loss: 1.0838 - val_loss: 0.2438
Epoch 89/100
99/99 - 5s - loss: 1.0835 - val_loss: 0.2474
Epoch 90/100
99/99 - 5s - loss: 1.0828 - val_loss: 0.2451
Epoch 91/100
99/99 - 5s - loss: 1.0829 - val_loss: 0.2484
Epoch 92/100
99/99 - 4s - loss: 1.0830 - val_loss: 0.2452
Epoch 93/100
99/99 - 4s - loss: 1.0878 - val_loss: 0.2467
Epoch 94/100
99/99 - 4s - loss: 1.0825 - val_loss: 0.2471
Epoch 95/100
99/99 - 4s - loss: 1.0821 - val_loss: 0.2471
Epoch 96/100
99/99 - 4s - loss: 1.0850 - val_loss: 0.2455
Epoch 97/100
99/99 - 4s - loss: 1.0830 - val_loss: 0.2487
Epoch 98/100
99/99 - 4s - loss: 1.0830 - val_loss: 0.2492
Epoch 99/100
99/99 - 4s - loss: 1.0816 - val_loss: 0.2461
Epoch 100/100
99/99 - 4s - loss: 1.0823 - val_loss: 0.2493
##################################################
</pre></div>
</div>
<img alt="../_images/openvaccine-transformers-lstm-gru_45_11.png" src="../_images/openvaccine-transformers-lstm-gru_45_11.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>##################################################
#### FOLD:  4
#### Train Shape:  (3163, 107, 11)
#### Validation Shape:  (318, 107, 11)
Model: &quot;functional_27&quot;
__________________________________________________________________________________________________
Layer (type)                    Output Shape         Param #     Connected to                     
==================================================================================================
input_14 (InputLayer)           [(None, 107, 11)]    0                                            
__________________________________________________________________________________________________
tf_op_layer_strided_slice_39 (T [(None, 107, 4)]     0           input_14[0][0]                   
__________________________________________________________________________________________________
embedding_13 (Embedding)        (None, 107, 4, 100)  1500        tf_op_layer_strided_slice_39[0][0
__________________________________________________________________________________________________
tf_op_layer_Reshape_13 (TensorF [(None, 107, 400)]   0           embedding_13[0][0]               
__________________________________________________________________________________________________
spatial_dropout1d_13 (SpatialDr (None, 107, 400)     0           tf_op_layer_Reshape_13[0][0]     
__________________________________________________________________________________________________
tf_op_layer_strided_slice_40 (T [(None, 107, 7)]     0           input_14[0][0]                   
__________________________________________________________________________________________________
concatenate_26 (Concatenate)    (None, 107, 407)     0           spatial_dropout1d_13[0][0]       
                                                                 tf_op_layer_strided_slice_40[0][0
__________________________________________________________________________________________________
conv1d_13 (Conv1D)              (None, 107, 256)     312832      concatenate_26[0][0]             
__________________________________________________________________________________________________
bidirectional_39 (Bidirectional (None, 107, 256)     296448      conv1d_13[0][0]                  
__________________________________________________________________________________________________
concatenate_27 (Concatenate)    (None, 107, 512)     0           bidirectional_39[0][0]           
                                                                 conv1d_13[0][0]                  
__________________________________________________________________________________________________
bidirectional_40 (Bidirectional (None, 107, 256)     493056      concatenate_27[0][0]             
__________________________________________________________________________________________________
bidirectional_41 (Bidirectional (None, 107, 256)     296448      bidirectional_40[0][0]           
__________________________________________________________________________________________________
tf_op_layer_strided_slice_41 (T [(None, 68, 256)]    0           bidirectional_41[0][0]           
__________________________________________________________________________________________________
dense_13 (Dense)                (None, 68, 5)        1285        tf_op_layer_strided_slice_41[0][0
==================================================================================================
Total params: 1,401,569
Trainable params: 1,401,569
Non-trainable params: 0
__________________________________________________________________________________________________


#### Training on Augmented Data: 
Epoch 1/100
99/99 - 7s - loss: 0.5390 - val_loss: 0.3391
Epoch 2/100
99/99 - 4s - loss: 0.4514 - val_loss: 0.3044
Epoch 3/100
99/99 - 4s - loss: 0.4297 - val_loss: 0.2934
Epoch 4/100
99/99 - 4s - loss: 0.4176 - val_loss: 0.2809
Epoch 5/100
99/99 - 4s - loss: 0.4073 - val_loss: 0.2678
Epoch 6/100
99/99 - 4s - loss: 0.3987 - val_loss: 0.2597
Epoch 7/100
99/99 - 4s - loss: 0.3906 - val_loss: 0.2536
Epoch 8/100
99/99 - 4s - loss: 0.3829 - val_loss: 0.2469
Epoch 9/100
99/99 - 4s - loss: 0.3763 - val_loss: 0.2419
Epoch 10/100
99/99 - 4s - loss: 0.3696 - val_loss: 0.2380
Epoch 11/100
99/99 - 4s - loss: 0.3639 - val_loss: 0.2330
Epoch 12/100
99/99 - 4s - loss: 0.3586 - val_loss: 0.2321
Epoch 13/100
99/99 - 5s - loss: 0.3540 - val_loss: 0.2272
Epoch 14/100
99/99 - 4s - loss: 0.3501 - val_loss: 0.2256
Epoch 15/100
99/99 - 4s - loss: 0.3469 - val_loss: 0.2244
Epoch 16/100
99/99 - 4s - loss: 0.3429 - val_loss: 0.2239
Epoch 17/100
99/99 - 4s - loss: 0.3398 - val_loss: 0.2218
Epoch 18/100
99/99 - 4s - loss: 0.3378 - val_loss: 0.2227
Epoch 19/100
99/99 - 4s - loss: 0.3348 - val_loss: 0.2199
Epoch 20/100
99/99 - 4s - loss: 0.3324 - val_loss: 0.2199
Epoch 21/100
99/99 - 4s - loss: 0.3298 - val_loss: 0.2204
Epoch 22/100
99/99 - 4s - loss: 0.3279 - val_loss: 0.2182
Epoch 23/100
99/99 - 4s - loss: 0.3255 - val_loss: 0.2177
Epoch 24/100
99/99 - 4s - loss: 0.3235 - val_loss: 0.2168
Epoch 25/100
99/99 - 4s - loss: 0.3221 - val_loss: 0.2179
Epoch 26/100
99/99 - 4s - loss: 0.3204 - val_loss: 0.2178
Epoch 27/100
99/99 - 4s - loss: 0.3190 - val_loss: 0.2165
Epoch 28/100
99/99 - 4s - loss: 0.3172 - val_loss: 0.2162
Epoch 29/100
99/99 - 4s - loss: 0.3157 - val_loss: 0.2150
Epoch 30/100
99/99 - 4s - loss: 0.3147 - val_loss: 0.2169
Epoch 31/100
99/99 - 4s - loss: 0.3134 - val_loss: 0.2149
Epoch 32/100
99/99 - 4s - loss: 0.3113 - val_loss: 0.2154
Epoch 33/100
99/99 - 4s - loss: 0.3109 - val_loss: 0.2163
Epoch 34/100
99/99 - 4s - loss: 0.3088 - val_loss: 0.2143
Epoch 35/100
99/99 - 4s - loss: 0.3073 - val_loss: 0.2146
Epoch 36/100
99/99 - 4s - loss: 0.3068 - val_loss: 0.2141
Epoch 37/100
99/99 - 4s - loss: 0.3061 - val_loss: 0.2143
Epoch 38/100
99/99 - 4s - loss: 0.3056 - val_loss: 0.2139
Epoch 39/100
99/99 - 4s - loss: 0.3039 - val_loss: 0.2153
Epoch 40/100
99/99 - 4s - loss: 0.3034 - val_loss: 0.2145
Epoch 41/100
99/99 - 4s - loss: 0.3029 - val_loss: 0.2150
Epoch 42/100
99/99 - 5s - loss: 0.3012 - val_loss: 0.2155
Epoch 43/100
99/99 - 4s - loss: 0.3008 - val_loss: 0.2153
Epoch 44/100
99/99 - 4s - loss: 0.3015 - val_loss: 0.2152
Epoch 45/100
99/99 - 4s - loss: 0.3013 - val_loss: 0.2125
Epoch 46/100
99/99 - 4s - loss: 0.2999 - val_loss: 0.2127
Epoch 47/100
99/99 - 4s - loss: 0.2982 - val_loss: 0.2127
Epoch 48/100
99/99 - 4s - loss: 0.2979 - val_loss: 0.2111
Epoch 49/100
99/99 - 4s - loss: 0.2983 - val_loss: 0.2129
Epoch 50/100
99/99 - 4s - loss: 0.2965 - val_loss: 0.2116
Epoch 51/100
99/99 - 4s - loss: 0.2962 - val_loss: 0.2138
Epoch 52/100
99/99 - 4s - loss: 0.2969 - val_loss: 0.2139
Epoch 53/100
99/99 - 4s - loss: 0.2954 - val_loss: 0.2115
Epoch 54/100
99/99 - 4s - loss: 0.2943 - val_loss: 0.2104
Epoch 55/100
99/99 - 4s - loss: 0.2933 - val_loss: 0.2109
Epoch 56/100
99/99 - 4s - loss: 0.2924 - val_loss: 0.2101
Epoch 57/100
99/99 - 5s - loss: 0.2909 - val_loss: 0.2096
Epoch 58/100
99/99 - 4s - loss: 0.2907 - val_loss: 0.2104
Epoch 59/100
99/99 - 4s - loss: 0.2904 - val_loss: 0.2113
Epoch 60/100
99/99 - 4s - loss: 0.2897 - val_loss: 0.2097
Epoch 61/100
99/99 - 4s - loss: 0.2888 - val_loss: 0.2093
Epoch 62/100
99/99 - 4s - loss: 0.2883 - val_loss: 0.2100
Epoch 63/100
99/99 - 4s - loss: 0.2881 - val_loss: 0.2092
Epoch 64/100
99/99 - 4s - loss: 0.2872 - val_loss: 0.2101
Epoch 65/100
99/99 - 4s - loss: 0.2867 - val_loss: 0.2096
Epoch 66/100
99/99 - 4s - loss: 0.2865 - val_loss: 0.2099
Epoch 67/100
99/99 - 4s - loss: 0.2861 - val_loss: 0.2105
Epoch 68/100
99/99 - 4s - loss: 0.2857 - val_loss: 0.2097
Epoch 69/100
99/99 - 4s - loss: 0.2856 - val_loss: 0.2099
Epoch 70/100
99/99 - 4s - loss: 0.2855 - val_loss: 0.2098
Epoch 71/100
99/99 - 4s - loss: 0.2848 - val_loss: 0.2099
Epoch 72/100
99/99 - 4s - loss: 0.2840 - val_loss: 0.2121
Epoch 73/100
99/99 - 4s - loss: 0.2848 - val_loss: 0.2119
Epoch 74/100
99/99 - 4s - loss: 0.2835 - val_loss: 0.2095
Epoch 75/100
99/99 - 4s - loss: 0.2830 - val_loss: 0.2108
Epoch 76/100
99/99 - 4s - loss: 0.2826 - val_loss: 0.2105
Epoch 77/100
99/99 - 4s - loss: 0.2823 - val_loss: 0.2105
Epoch 78/100
99/99 - 4s - loss: 0.2816 - val_loss: 0.2107
Epoch 79/100
99/99 - 4s - loss: 0.2807 - val_loss: 0.2101
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 80/100
99/99 - 4s - loss: 0.2808 - val_loss: 0.2109
Epoch 81/100
99/99 - 4s - loss: 0.2819 - val_loss: 0.2112
Epoch 82/100
99/99 - 4s - loss: 0.2815 - val_loss: 0.2110
Epoch 83/100
99/99 - 4s - loss: 0.2806 - val_loss: 0.2104
Epoch 84/100
99/99 - 4s - loss: 0.2803 - val_loss: 0.2134
Epoch 85/100
99/99 - 4s - loss: 0.2808 - val_loss: 0.2103
Epoch 86/100
99/99 - 4s - loss: 0.2801 - val_loss: 0.2122
Epoch 87/100
99/99 - 4s - loss: 0.2806 - val_loss: 0.2096
Epoch 88/100
99/99 - 4s - loss: 0.2801 - val_loss: 0.2095
Epoch 89/100
99/99 - 4s - loss: 0.2789 - val_loss: 0.2090
Epoch 90/100
99/99 - 4s - loss: 0.2793 - val_loss: 0.2099
Epoch 91/100
99/99 - 4s - loss: 0.2783 - val_loss: 0.2085
Epoch 92/100
99/99 - 4s - loss: 0.2791 - val_loss: 0.2103
Epoch 93/100
99/99 - 4s - loss: 0.2785 - val_loss: 0.2100
Epoch 94/100
99/99 - 4s - loss: 0.2781 - val_loss: 0.2095
Epoch 95/100
99/99 - 4s - loss: 0.2781 - val_loss: 0.2102
Epoch 96/100
99/99 - 4s - loss: 0.2776 - val_loss: 0.2113
Epoch 97/100
99/99 - 4s - loss: 0.2774 - val_loss: 0.2093
Epoch 98/100
99/99 - 4s - loss: 0.2769 - val_loss: 0.2105
Epoch 99/100
99/99 - 4s - loss: 0.2759 - val_loss: 0.2115
Epoch 100/100
99/99 - 4s - loss: 0.2756 - val_loss: 0.2100
##################################################
</pre></div>
</div>
<img alt="../_images/openvaccine-transformers-lstm-gru_45_14.png" src="../_images/openvaccine-transformers-lstm-gru_45_14.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CPU times: user 36min 3s, sys: 3min 5s, total: 39min 8s
Wall time: 38min 25s
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Leakage-Check</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ids</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">oof_ids</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;#ids: &quot;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ids</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">oof_ids</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Fold_</span><span class="si">{i}</span><span class="s1"> ids intersection Fold_</span><span class="si">{j}</span><span class="s1"> ids: &#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">oof_ids</span><span class="p">[</span><span class="n">j</span><span class="p">]))))</span>
    <span class="nb">print</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Total ids: &quot;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">oof_ids</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>#ids:  318
Fold_0 ids intersection Fold_1 ids:  0
Fold_0 ids intersection Fold_2 ids:  0
Fold_0 ids intersection Fold_3 ids:  0
Fold_0 ids intersection Fold_4 ids:  0

#ids:  318
Fold_1 ids intersection Fold_2 ids:  0
Fold_1 ids intersection Fold_3 ids:  0
Fold_1 ids intersection Fold_4 ids:  0

#ids:  317
Fold_2 ids intersection Fold_3 ids:  0
Fold_2 ids intersection Fold_4 ids:  0

#ids:  318
Fold_3 ids intersection Fold_4 ids:  0

#ids:  318

Total ids:  (1589,)
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="inference">
<h2>7. Inference<a class="headerlink" href="#inference" title="Permalink to this headline">¬∂</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>

<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="n">f</span><span class="s1">&#39;Fold_</span><span class="si">{fold}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">fold</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">FOLDS</span><span class="p">)],</span><span class="n">y</span><span class="o">=</span><span class="n">oof_val</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;OOF RMSE&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/openvaccine-transformers-lstm-gru_48_0.png" src="../_images/openvaccine-transformers-lstm-gru_48_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">oof_rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">oof_val</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Val Losses: &quot;</span><span class="p">,</span><span class="n">oof_val</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Mean Loss: </span><span class="si">{oof_rmse}</span><span class="s2"> +/- {np.std(oof_val)}&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Val Losses:  [0.20719186961650848, 0.20266330242156982, 0.20548886060714722, 0.24122948944568634, 0.20853212475776672]
Mean Loss: 0.21302112936973572 +/- 0.014239822061046807
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">oof_pred_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">oof_pred</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="n">oof_tar_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">oof_tar</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>

<span class="n">oof_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">oof_ids</span><span class="p">)</span>
<span class="p">})</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">target_cols</span><span class="p">):</span>
    <span class="n">oof_df</span><span class="p">[</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{target}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">oof_tar_</span><span class="p">[:,</span><span class="n">i</span><span class="p">,:])</span>
    <span class="n">oof_df</span><span class="p">[</span><span class="n">f</span><span class="s1">&#39;pred_</span><span class="si">{target}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">oof_pred_</span><span class="p">[:,</span><span class="n">i</span><span class="p">,:])</span>

<span class="n">oof_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>reactivity</th>
      <th>pred_reactivity</th>
      <th>deg_Mg_pH10</th>
      <th>pred_deg_Mg_pH10</th>
      <th>deg_pH10</th>
      <th>pred_deg_pH10</th>
      <th>deg_Mg_50C</th>
      <th>pred_deg_Mg_50C</th>
      <th>deg_50C</th>
      <th>pred_deg_50C</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>id_01e2cf40a</td>
      <td>[0.0885, 0.4917, 1.0091, 0.5838, 0.6308, 0.319...</td>
      <td>[0.3798892, 0.7104439, 0.83789104, 0.6877659, ...</td>
      <td>[0.5652, 1.0096, 0.5626, 0.5263, 0.4265, 0.293...</td>
      <td>[0.5115307, 0.9265191, 0.53880554, 0.49818122,...</td>
      <td>[2.7149, 1.8073, 0.9468, 1.0909, 0.6464, 0.391...</td>
      <td>[3.0617764, 2.123595, 0.9945534, 0.8639574, 0....</td>
      <td>[0.2115, 1.393, 0.6087, 0.7529, 0.5446, 0.5488...</td>
      <td>[0.41487715, 0.9219454, 0.7267554, 0.70796776,...</td>
      <td>[0.5871, 1.6406, 1.0466, 0.7835, 0.6923, 0.212...</td>
      <td>[0.5920927, 1.1220834, 0.9702585, 0.99528855, ...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>id_01f38f83d</td>
      <td>[0.2409, 0.6422, 0.817, 0.624, 0.3989, 0.1452,...</td>
      <td>[0.2597174, 0.69900924, 0.6811634, 0.6267096, ...</td>
      <td>[0.3139, 1.0881, 0.9641, 0.4587, 0.2884, 0.382...</td>
      <td>[0.4454846, 1.1439224, 0.5567084, 0.38207164, ...</td>
      <td>[1.2859, 1.1294, 0.7452, 0.451, 0.3603, 0.4036...</td>
      <td>[1.2197846, 1.1471769, 0.6287319, 0.46598333, ...</td>
      <td>[0.2833, 1.0513, 0.5702, 0.2063, 0.2736, 0.229...</td>
      <td>[0.31221324, 1.1336367, 0.67014855, 0.41369876...</td>
      <td>[0.5461, 1.404, 1.0043, 0.852, 0.5093, 0.3388,...</td>
      <td>[0.4942109, 1.0666394, 0.83575755, 0.7039495, ...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>id_02612d250</td>
      <td>[0.2589, 1.6595, 1.3381, 1.214, 1.0558, 0.4361...</td>
      <td>[0.46522003, 1.316354, 1.1738336, 0.94997483, ...</td>
      <td>[0.4164, 2.9632, 0.139, 1.1201, 0.4091, 0.5567...</td>
      <td>[0.58326733, 2.6906033, 0.3291871, 1.2514719, ...</td>
      <td>[2.6594, 4.2289, 0.33, 0.9369, 0.6087, 0.5338,...</td>
      <td>[2.1165626, 3.7129626, 0.20770954, 0.9623808, ...</td>
      <td>[0.6235, 3.7651, 0.3174, 1.9311, 0.7508, 0.373...</td>
      <td>[0.48952064, 3.2249997, 0.14515859, 1.5609266,...</td>
      <td>[0.9468, 3.3142, 0.7758, 1.8853, 1.1269, 0.487...</td>
      <td>[0.7825191, 3.4393265, 0.6272369, 1.228261, 0....</td>
    </tr>
    <tr>
      <th>3</th>
      <td>id_07dcc5ff8</td>
      <td>[0.2343, 0.7147, 0.5304, 0.5352, 0.6371, 0.459...</td>
      <td>[0.44430315, 1.4291251, 0.97888434, 0.74746615...</td>
      <td>[0.3704, 0.9429, 0.1569, 0.4065, 0.7857, 0.351...</td>
      <td>[0.30638525, 1.3984121, 0.1830818, 0.4828159, ...</td>
      <td>[1.7813, 1.9396, 0.2663, 0.3861, 0.7424, 0.445...</td>
      <td>[1.5917028, 2.8597882, 0.36288634, 0.50863254,...</td>
      <td>[0.2455, 1.1524, 0.1583, 0.4763, 0.784, 0.4378...</td>
      <td>[0.32836363, 1.952748, 0.17820191, 0.74127233,...</td>
      <td>[0.5317, 1.224, 0.4784, 0.5558, 0.8686, 0.5119...</td>
      <td>[0.5052952, 2.0065968, 0.6200771, 0.748403, 1....</td>
    </tr>
    <tr>
      <th>4</th>
      <td>id_088cef62f</td>
      <td>[0.4268, 1.5837, 1.4222, 0.8576, 0.1081, 0.119...</td>
      <td>[0.5567379, 1.3593235, 1.3058133, 0.96818566, ...</td>
      <td>[0.5323, 2.2489, 0.7938, 0.5416, 0.5655, 0.154...</td>
      <td>[0.47736758, 1.9774611, 0.91892844, 0.5510109,...</td>
      <td>[1.4026, 3.2834, 1.1345, 0.9945, 0.5993, 0.206...</td>
      <td>[1.9968612, 3.1650236, 1.2045041, 0.79135615, ...</td>
      <td>[0.2887, 2.1497, 0.8337, 0.9057, 1.2197, 0.175...</td>
      <td>[0.4586471, 1.9444696, 1.2261198, 0.8699358, 1...</td>
      <td>[0.4534, 1.5328, 1.1025, 0.8581, 0.4845, 0.257...</td>
      <td>[0.69322234, 1.7885101, 1.3249803, 1.0457826, ...</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">preprocess</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    
    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        
        <span class="n">seq_length</span> <span class="o">=</span> <span class="mi">68</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">seq_length</span><span class="p">):</span>
            <span class="n">preprocessed</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">sample</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="s1">&#39;id_seqpos&#39;</span><span class="p">:</span> <span class="n">sample</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>
            <span class="p">}</span>
            
                
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">target_cols</span><span class="p">:</span>
                <span class="n">preprocessed</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="n">preprocessed</span><span class="p">[</span><span class="n">f</span><span class="s1">&#39;pred_</span><span class="si">{col}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample</span><span class="p">[</span><span class="n">f</span><span class="s1">&#39;pred_</span><span class="si">{col}</span><span class="s1">&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">preprocessed</span><span class="p">)</span>
    
    <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">data</span>

<span class="n">oof_df_</span> <span class="o">=</span> <span class="n">preprocess</span><span class="p">(</span><span class="n">oof_df</span><span class="p">)</span>

<span class="n">oof_df_</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 1589/1589 [00:09&lt;00:00, 160.81it/s]
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>id_seqpos</th>
      <th>reactivity</th>
      <th>pred_reactivity</th>
      <th>deg_Mg_pH10</th>
      <th>pred_deg_Mg_pH10</th>
      <th>deg_pH10</th>
      <th>pred_deg_pH10</th>
      <th>deg_Mg_50C</th>
      <th>pred_deg_Mg_50C</th>
      <th>deg_50C</th>
      <th>pred_deg_50C</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>id_01e2cf40a</td>
      <td>id_01e2cf40a_0</td>
      <td>0.0885</td>
      <td>0.379889</td>
      <td>0.5652</td>
      <td>0.511531</td>
      <td>2.7149</td>
      <td>3.061776</td>
      <td>0.2115</td>
      <td>0.414877</td>
      <td>0.5871</td>
      <td>0.592093</td>
    </tr>
    <tr>
      <th>1</th>
      <td>id_01e2cf40a</td>
      <td>id_01e2cf40a_1</td>
      <td>0.4917</td>
      <td>0.710444</td>
      <td>1.0096</td>
      <td>0.926519</td>
      <td>1.8073</td>
      <td>2.123595</td>
      <td>1.3930</td>
      <td>0.921945</td>
      <td>1.6406</td>
      <td>1.122083</td>
    </tr>
    <tr>
      <th>2</th>
      <td>id_01e2cf40a</td>
      <td>id_01e2cf40a_2</td>
      <td>1.0091</td>
      <td>0.837891</td>
      <td>0.5626</td>
      <td>0.538806</td>
      <td>0.9468</td>
      <td>0.994553</td>
      <td>0.6087</td>
      <td>0.726755</td>
      <td>1.0466</td>
      <td>0.970258</td>
    </tr>
    <tr>
      <th>3</th>
      <td>id_01e2cf40a</td>
      <td>id_01e2cf40a_3</td>
      <td>0.5838</td>
      <td>0.687766</td>
      <td>0.5263</td>
      <td>0.498181</td>
      <td>1.0909</td>
      <td>0.863957</td>
      <td>0.7529</td>
      <td>0.707968</td>
      <td>0.7835</td>
      <td>0.995289</td>
    </tr>
    <tr>
      <th>4</th>
      <td>id_01e2cf40a</td>
      <td>id_01e2cf40a_4</td>
      <td>0.6308</td>
      <td>0.741025</td>
      <td>0.4265</td>
      <td>0.454379</td>
      <td>0.6464</td>
      <td>0.712513</td>
      <td>0.5446</td>
      <td>0.573043</td>
      <td>0.6923</td>
      <td>0.873730</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scored_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;reactivity&#39;</span><span class="p">,</span><span class="s1">&#39;deg_Mg_50C&#39;</span><span class="p">,</span><span class="s1">&#39;deg_Mg_pH10&#39;</span><span class="p">]</span>

<span class="n">scored_rmse</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">scored_cols</span><span class="p">:</span>
    <span class="n">col_rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">oof_df_</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">-</span> <span class="n">oof_df_</span><span class="p">[</span><span class="n">f</span><span class="s1">&#39;pred_</span><span class="si">{col}</span><span class="s1">&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;</span><span class="si">{col}</span><span class="s2"> RMSE: &quot;</span><span class="p">,</span><span class="n">col_rmse</span><span class="p">)</span>
    <span class="n">scored_rmse</span> <span class="o">+=</span> <span class="n">col_rmse</span>
    
<span class="n">scored_rmse</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">scored_cols</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">RMSE on Scored Targets (Whole Train data): &quot;</span><span class="p">,</span><span class="n">scored_rmse</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>

<span class="n">SN_FILTER</span> <span class="o">=</span> <span class="n">train</span><span class="p">[[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span><span class="s1">&#39;SN_filter&#39;</span><span class="p">]]</span>
<span class="k">if</span> <span class="n">AUGMENTED</span><span class="p">:</span>
    <span class="n">SN_FILTER</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="n">train</span><span class="o">.</span><span class="n">cnt</span><span class="o">==</span><span class="mi">1</span><span class="p">][[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span><span class="s1">&#39;SN_filter&#39;</span><span class="p">]]</span>

<span class="n">oof_df_filtered</span> <span class="o">=</span> <span class="n">oof_df_</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">SN_FILTER</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="s1">&#39;id&#39;</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
<span class="n">oof_df_filtered</span> <span class="o">=</span> <span class="n">oof_df_filtered</span><span class="p">[</span><span class="n">oof_df_filtered</span><span class="o">.</span><span class="n">SN_filter</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span>

<span class="n">filtered_scored_rmse</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">scored_cols</span><span class="p">:</span>
    <span class="n">col_rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">oof_df_filtered</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">-</span> <span class="n">oof_df_filtered</span><span class="p">[</span><span class="n">f</span><span class="s1">&#39;pred_</span><span class="si">{col}</span><span class="s1">&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;</span><span class="si">{col}</span><span class="s2"> RMSE: &quot;</span><span class="p">,</span><span class="n">col_rmse</span><span class="p">)</span>
    <span class="n">filtered_scored_rmse</span> <span class="o">+=</span> <span class="n">col_rmse</span>
    
<span class="n">filtered_scored_rmse</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">scored_cols</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RMSE on Scored Targets (Filtered Data): &quot;</span><span class="p">,</span><span class="n">filtered_scored_rmse</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>reactivity RMSE:  0.21332149359659683
deg_Mg_50C RMSE:  0.220755019346457
deg_Mg_pH10 RMSE:  0.26546846954198156

RMSE on Scored Targets (Whole Train data):  0.23318166082834513

##################################################

reactivity RMSE:  0.21332149359659683
deg_Mg_50C RMSE:  0.220755019346457
deg_Mg_pH10 RMSE:  0.26546846954198156
RMSE on Scored Targets (Filtered Data):  0.23318166082834513
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">oof_df_</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;oof_</span><span class="si">{oof_rmse}</span><span class="s1">_</span><span class="si">{scored_rmse}</span><span class="s1">_</span><span class="si">{filtered_scored_rmse}</span><span class="s1">.csv&#39;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="test-set-predictions">
<h3>8. Test set Predictions<a class="headerlink" href="#test-set-predictions" title="Permalink to this headline">¬∂</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_preds</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">df</span><span class="p">,</span> <span class="n">preds</span> <span class="ow">in</span> <span class="p">[(</span><span class="n">public_df</span><span class="p">,</span> <span class="n">public_preds</span><span class="p">),</span> <span class="p">(</span><span class="n">private_df</span><span class="p">,</span> <span class="n">private_preds</span><span class="p">)]:</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">uid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">id</span><span class="p">):</span>
        <span class="n">single_pred</span> <span class="o">=</span> <span class="n">preds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="n">single_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">single_pred</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">target_cols</span><span class="p">)</span>
        <span class="n">single_df</span><span class="p">[</span><span class="s1">&#39;id_seqpos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{uid}</span><span class="s1">_</span><span class="si">{x}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">single_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>

        <span class="n">test_preds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">single_df</span><span class="p">)</span>

<span class="n">test_preds_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">test_preds</span><span class="p">)</span>
<span class="n">test_preds_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>reactivity</th>
      <th>deg_Mg_pH10</th>
      <th>deg_pH10</th>
      <th>deg_Mg_50C</th>
      <th>deg_50C</th>
      <th>id_seqpos</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.721219</td>
      <td>0.630818</td>
      <td>1.899849</td>
      <td>0.540164</td>
      <td>0.693511</td>
      <td>id_00073f8be_0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2.152375</td>
      <td>3.178208</td>
      <td>3.872319</td>
      <td>3.130266</td>
      <td>2.538820</td>
      <td>id_00073f8be_1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1.398012</td>
      <td>0.512405</td>
      <td>0.620175</td>
      <td>0.621889</td>
      <td>0.653833</td>
      <td>id_00073f8be_2</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1.205574</td>
      <td>1.078343</td>
      <td>1.160261</td>
      <td>1.563113</td>
      <td>1.698380</td>
      <td>id_00073f8be_3</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.726833</td>
      <td>0.564324</td>
      <td>0.533283</td>
      <td>0.810658</td>
      <td>0.878944</td>
      <td>id_00073f8be_4</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">submission</span> <span class="o">=</span> <span class="n">sub</span><span class="p">[[</span><span class="s1">&#39;id_seqpos&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">test_preds_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;id_seqpos&#39;</span><span class="p">])</span>

<span class="n">submission</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id_seqpos</th>
      <th>reactivity</th>
      <th>deg_Mg_pH10</th>
      <th>deg_pH10</th>
      <th>deg_Mg_50C</th>
      <th>deg_50C</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>id_00073f8be_0</td>
      <td>0.721219</td>
      <td>0.630818</td>
      <td>1.899849</td>
      <td>0.540164</td>
      <td>0.693511</td>
    </tr>
    <tr>
      <th>1</th>
      <td>id_00073f8be_1</td>
      <td>2.152375</td>
      <td>3.178208</td>
      <td>3.872319</td>
      <td>3.130266</td>
      <td>2.538820</td>
    </tr>
    <tr>
      <th>2</th>
      <td>id_00073f8be_2</td>
      <td>1.398012</td>
      <td>0.512405</td>
      <td>0.620175</td>
      <td>0.621889</td>
      <td>0.653833</td>
    </tr>
    <tr>
      <th>3</th>
      <td>id_00073f8be_3</td>
      <td>1.205574</td>
      <td>1.078343</td>
      <td>1.160261</td>
      <td>1.563113</td>
      <td>1.698380</td>
    </tr>
    <tr>
      <th>4</th>
      <td>id_00073f8be_4</td>
      <td>0.726833</td>
      <td>0.564324</td>
      <td>0.533283</td>
      <td>0.810658</td>
      <td>0.878944</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">submission</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;submission_</span><span class="si">{oof_rmse}</span><span class="s1">_</span><span class="si">{scored_rmse}</span><span class="s1">_</span><span class="si">{filtered_scored_rmse}</span><span class="s1">.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./Our_solution"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        </div>
    </div>
    
    
    <div class='prev-next-bottom'>
        
    <a class='left-prev' id="prev-link" href="Single_model_Perfomance.html" title="previous page">Vatsal‚Äôs Single Model Details</a>
    <a class='right-next' id="next-link" href="single-model-results.html" title="next page">Meet‚Äôs Single Models Details</a>

    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Vatsal Parsaniya , Meet Ranoliya<br/>
        
            &copy; Copyright 2020.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    
  <script src="../_static/js/index.3da636dd464baa7582d2.js"></script>


    
  </body>
</html>